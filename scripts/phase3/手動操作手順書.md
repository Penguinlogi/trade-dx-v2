# Phase 3: 差分同期機能 - 手動操作手順書

## 🎯 動作確認の目的

Phase 3の差分同期機能が正しく動作することを確認します。

- ✅ 未同期データの抽出
- ✅ マスターファイルへの反映
- ✅ 同期済みフラグの更新
- ✅ 2回目実行での重複防止

---

## 📋 手順1: テストデータの作成

### 1-1. テストデータ作成スクリプトの実行

```bash
cd "C:\Users\関伸\OneDrive - ペンギンロジスティクス株式会社\ドキュメント\ペンギンロジスティクス\e 営業部門\c AI事業部門\CURSOR\貿易DX"

python scripts\phase3\create_test_data.py
```

**期待される出力:**
```
============================================================
Phase 3 テストデータ作成
============================================================

📁 ディレクトリ:
  - マスター: C:\...\master
  - 作業: C:\...\work

【1. マスターファイル作成】
  ✅ 作成: 案件管理台帳_マスター.xlsm
     件数: 3件

【2. 個人ファイル作成】
  ✅ 作成: 案件管理台帳_マスター_yamada.xlsm
     件数: 2件
     未同期: 2件
  ✅ 作成: 案件管理台帳_マスター_suzuki.xlsm
     件数: 1件
     未同期: 0件
  ✅ 作成: 案件管理台帳_マスター_satou.xlsm
     件数: 1件
     未同期: 1件

============================================================
✅ テストデータ作成完了
============================================================

【期待される同期結果】
  - 山田さん: 2件同期（EX-001更新 + EX-004新規）
  - 鈴木さん: 0件（すでに同期済み）
  - 佐藤さん: 1件同期（IM-001更新）
  - 合計: 3件が同期されるはず
```

### 1-2. 作成されたファイルの確認

エクスプローラーで以下のファイルが作成されていることを確認します：

```
master/
└── 案件管理台帳_マスター.xlsm  ← マスターファイル（3件）

work/
├── 案件管理台帳_マスター_yamada.xlsm  ← 山田さん（2件、未同期）
├── 案件管理台帳_マスター_suzuki.xlsm  ← 鈴木さん（1件、同期済み）
└── 案件管理台帳_マスター_satou.xlsm   ← 佐藤さん（1件、未同期）
```

---

## 📊 手順2: 同期前のデータ確認

### 2-1. マスターファイルの確認

Excelで `master/案件管理台帳_マスター.xlsm` を開き、以下を確認：

| 案件番号 | 顧客名 | 数量 | ステータス | 担当者 |
|---------|--------|-----|-----------|--------|
| 2025-EX-001 | テスト商事株式会社 | **100** | 進行中 | 山田 |
| 2025-EX-002 | サンプル貿易 | 200 | 完了 | 鈴木 |
| 2025-IM-001 | デモインポート | **150** | 進行中 | 佐藤 |

**合計: 3件**

### 2-2. 個人ファイルの確認

#### 山田さんのファイル (`work/案件管理台帳_マスター_yamada.xlsm`)

| 案件番号 | 顧客名 | 数量 | 備考 | _同期済み |
|---------|--------|-----|------|----------|
| 2025-EX-001 | テスト商事株式会社 | **150** | 数量を更新しました | **False** |
| 2025-EX-004 | 新規顧客株式会社 | 300 | 新規案件です | **False** |

**未同期: 2件**

#### 鈴木さんのファイル (`work/案件管理台帳_マスター_suzuki.xlsm`)

| 案件番号 | 顧客名 | 数量 | _同期済み |
|---------|--------|-----|----------|
| 2025-EX-002 | サンプル貿易 | 200 | **True** |

**未同期: 0件**

#### 佐藤さんのファイル (`work/案件管理台帳_マスター_satou.xlsm`)

| 案件番号 | 顧客名 | 数量 | ステータス | _同期済み |
|---------|--------|-----|-----------|----------|
| 2025-IM-001 | デモインポート | **180** | 検査中 | **False** |

**未同期: 1件**

---

## 🚀 手順3: 差分同期の実行

### 3-1. 差分同期スクリプトの実行

```bash
# 方法1: バッチファイルで実行
scripts\phase3\run_sync.bat

# 方法2: Pythonで直接実行
python scripts\phase3\incremental_sync.py
```

**期待される出力:**
```
============================================================
差分同期開始 (2025-11-20 10:30:00)
============================================================
ユーザー処理開始: 山田
山田: 2件の未同期データ
ユーザー処理開始: 鈴木
鈴木: 未同期データなし
ユーザー処理開始: 佐藤
佐藤: 1件の未同期データ
マスターファイル更新開始
結合後の未同期データ: 3件
新規案件: 1件、更新案件: 2件
バックアップ作成: 案件管理台帳_マスター_backup_20251120_103000.xlsm
マスター更新成功: 3件
同期フラグ更新開始
山田: 2件を同期済みに更新
佐藤: 1件を同期済みに更新
============================================================
差分同期完了: 3件、2ユーザー
============================================================
```

### 3-2. ログファイルの確認

`logs/sync_20251120.log` を開いて、エラーがないことを確認します。

---

## ✅ 手順4: 同期後のデータ確認

### 4-1. マスターファイルの確認

Excelで `master/案件管理台帳_マスター.xlsm` を開き、以下を確認：

| 案件番号 | 顧客名 | 数量 | ステータス | 担当者 | 備考 |
|---------|--------|-----|-----------|--------|------|
| 2025-EX-001 | テスト商事株式会社 | **150** ✅ | 進行中 | 山田 | 数量を更新しました |
| 2025-EX-002 | サンプル貿易 | 200 | 完了 | 鈴木 | |
| 2025-IM-001 | デモインポート | **180** ✅ | 検査中 | 佐藤 | 数量追加、検査開始 |
| 2025-EX-004 | 新規顧客株式会社 | 300 | 見積中 | 山田 | 新規案件です |

**合計: 4件** (1件追加 ✅)

**確認ポイント:**
- ✅ EX-001の数量が 100 → **150** に更新されている
- ✅ IM-001の数量が 150 → **180** に更新されている
- ✅ IM-001のステータスが「進行中」→「検査中」に更新されている
- ✅ EX-004が新規追加されている

### 4-2. 個人ファイルの同期フラグ確認

#### 山田さんのファイル

| 案件番号 | _同期済み | _同期日時 |
|---------|----------|----------|
| 2025-EX-001 | **True** ✅ | 2025-11-20 10:30:00 |
| 2025-EX-004 | **True** ✅ | 2025-11-20 10:30:00 |

**確認ポイント:**
- ✅ すべての `_同期済み` が True になっている
- ✅ `_同期日時` が記録されている

#### 佐藤さんのファイル

| 案件番号 | _同期済み | _同期日時 |
|---------|----------|----------|
| 2025-IM-001 | **True** ✅ | 2025-11-20 10:30:00 |

**確認ポイント:**
- ✅ `_同期済み` が True になっている

### 4-3. バックアップファイルの確認

`backup/` ディレクトリに以下のファイルが作成されていることを確認：

```
backup/
└── 案件管理台帳_マスター_backup_20251120_HHMMSS.xlsm
```

このファイルには同期前のマスターデータが保存されています。

---

## 🔄 手順5: 2回目の同期実行（重複防止確認）

### 5-1. 2回目の実行

もう一度差分同期を実行します：

```bash
python scripts\phase3\incremental_sync.py
```

**期待される出力:**
```
============================================================
差分同期開始 (2025-11-20 10:35:00)
============================================================
ユーザー処理開始: 山田
山田: 未同期データなし
ユーザー処理開始: 鈴木
鈴木: 未同期データなし
ユーザー処理開始: 佐藤
佐藤: 未同期データなし
同期対象データなし
============================================================
```

**確認ポイント:**
- ✅ 「同期対象データなし」と表示される
- ✅ マスターファイルの件数が変わらない（4件のまま）
- ✅ 重複して追加されていない

---

## 🧪 手順6: 手動テストツールの実行（オプション）

より詳細な確認を行いたい場合は、手動テストツールを使用します：

```bash
python scripts\phase3\demo_manual_test.py
```

このツールは6つのテストシナリオを自動で実行し、詳細な結果を表示します。

---

## 📝 確認チェックリスト

以下の項目が全て ✅ になれば、Phase 3の動作確認は完了です：

- [ ] テストデータが正しく作成された
- [ ] マスターファイルに3件のデータがある
- [ ] 個人ファイルに未同期データがある
- [ ] 差分同期が正常に実行された
- [ ] マスターファイルが4件に増えた
- [ ] EX-001の数量が150に更新された
- [ ] IM-001の数量が180に更新された
- [ ] EX-004が新規追加された
- [ ] 個人ファイルの同期フラグが True になった
- [ ] バックアップファイルが作成された
- [ ] 2回目の実行で「同期対象データなし」と表示された
- [ ] ログファイルにエラーがない

---

## 🔧 トラブルシューティング

### Q1: "ファイルが見つかりません" エラー

**原因:** テストデータが作成されていない

**対処法:**
```bash
python scripts\phase3\create_test_data.py
```

### Q2: "ファイルがロック中" 警告

**原因:** Excelファイルが開かれている

**対処法:**
- 全てのExcelファイルを閉じてから再実行

### Q3: 同期件数が期待と異なる

**原因:** 同期フラグが正しく設定されていない

**対処法:**
1. テストデータを再作成
2. ログファイルを確認してエラーをチェック

---

## 📞 問題が解決しない場合

1. ログファイル (`logs/sync_YYYYMMDD.log`) を確認
2. エラーメッセージをコピー
3. 開発チームに報告

---

**作成日**: 2025-11-20  
**対象フェーズ**: Phase 3（差分同期機能）


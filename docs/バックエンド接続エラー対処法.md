# バックエンド接続エラー対処法

## 🔴 エラー内容

```
データの取得に失敗しました: トレンド: ネットワークエラー: サーバーに接続できません
```

このエラーは、フロントエンドがバックエンドAPIに接続できないことを示しています。

---

## 🔍 原因の特定

### 1. Render.comのバックエンドがスリープ状態

**Render.com無料プランの特徴**:
- 一定時間（約15分）アイドル状態になると自動的にスリープします
- スリープ状態から復帰するには30秒〜1分程度かかります
- 初回アクセス時は非常に遅い場合があります

### 2. バックエンドのURL設定が間違っている

フロントエンドの環境変数 `VITE_API_BASE_URL` が正しく設定されているか確認が必要です。

### 3. バックエンドのデプロイが失敗している

Render.comダッシュボードでバックエンドサービスの状態を確認する必要があります。

---

## ✅ 対処方法

### ステップ1: バックエンドの状態を確認

1. **Render.comダッシュボードにアクセス**
   - https://dashboard.render.com/ にログイン

2. **バックエンドサービスを確認**
   - 左側メニューで「Web Services」をクリック
   - `trade-dx-v2` サービスをクリック

3. **サービスの状態を確認**
   - ステータスが「Live」になっているか確認
   - 「Unavailable」や「Build failed」の場合は、ログを確認

4. **ログを確認**
   - 「Logs」タブでエラーログがないか確認
   - 「Events」タブで最近のデプロイ状況を確認

### ステップ2: バックエンドに直接アクセスして確認

ブラウザで以下のURLに直接アクセス：

```
https://trade-dx-v2.onrender.com/health
```

**期待されるレスポンス**:
```json
{
  "status": "healthy",
  "app_name": "貿易DX管理システム",
  "version": "2.1.0"
}
```

**確認項目**:
- ✅ レスポンスが返ってくる → バックエンドは起動している（スリープからの復帰を待つ）
- ❌ タイムアウトまたはエラー → バックエンドが起動していない可能性

### ステップ3: フロントエンドの環境変数を確認

Render.comのフロントエンドサービス設定を確認：

1. **Render.comダッシュボードでフロントエンドサービスを開く**
   - 「Static Sites」→ `trade-dx-frontend`

2. **環境変数を確認**
   - 「Environment」セクションで `VITE_API_BASE_URL` を確認
   - 値が `https://trade-dx-v2.onrender.com` になっているか確認

3. **環境変数が間違っている場合**
   - 正しい値に更新
   - 「Save Changes」をクリック
   - 自動的に再デプロイが開始されます

### ステップ4: ブラウザの開発者ツールで確認

1. **F12キーで開発者ツールを開く**
2. **Networkタブを開く**
3. **ページをリロード**
4. **APIリクエストを確認**
   - `/api/analytics/trends` などのリクエストの状態を確認
   - ステータスコードが表示されているか確認

**確認項目**:
- `pending` のまま → タイムアウト（サーバーがスリープ中）
- `failed` または `ERR_NETWORK` → 接続エラー
- `404` → エンドポイントが見つからない
- `500` → サーバーエラー

---

## 🔧 具体的な対処手順

### ケース1: バックエンドがスリープ状態の場合

**対処法**: 少し待ってから再度アクセス

1. バックエンドのヘルスチェックURLにアクセス
   ```
   https://trade-dx-v2.onrender.com/health
   ```
2. 30秒〜1分待つ（スリープからの復帰時間）
3. 再度ダッシュボードページをリロード

**予防策**:
- 定期的にアクセスしてスリープを防ぐ（推奨：外部pingサービスを使用）
- または、Render.comの有料プランにアップグレード（常時起動）

### ケース2: バックエンドが起動していない場合

**対処法**: バックエンドを再起動または再デプロイ

1. Render.comダッシュボードでバックエンドサービスを開く
2. 「Manual Deploy」セクションで「Deploy latest commit」をクリック
3. デプロイ完了を待つ（5-10分）
4. 再度ダッシュボードページをリロード

### ケース3: 環境変数が間違っている場合

**対処法**: 環境変数を修正

1. フロントエンドサービスの「Environment」セクションを開く
2. `VITE_API_BASE_URL` の値を確認・修正
   - 正しい値: `https://trade-dx-v2.onrender.com`
3. 「Save Changes」をクリック
4. 再デプロイ完了を待つ（3-5分）
5. ブラウザのキャッシュをクリア（Ctrl+Shift+R）

---

## 🔄 一時的な回避策

### スリープ問題の回避（外部pingサービス）

Render.com無料プランでも、外部pingサービスを使用してスリープを防ぐことができます：

**推奨サービス**:
- UptimeRobot（無料プランあり）
- Cron-job.org（無料プランあり）
- EasyCron（無料プランあり）

**設定方法**:
1. サービスにアカウントを作成
2. 監視対象URLを設定: `https://trade-dx-v2.onrender.com/health`
3. 監視間隔を5分に設定
4. これにより、バックエンドがスリープしにくくなります

---

## 📝 確認チェックリスト

- [ ] Render.comダッシュボードでバックエンドサービスの状態を確認
- [ ] バックエンドのヘルスチェックURLに直接アクセスして確認
- [ ] フロントエンドの環境変数 `VITE_API_BASE_URL` を確認
- [ ] ブラウザの開発者ツール（Networkタブ）でAPIリクエストの状態を確認
- [ ] バックエンドがスリープ状態の場合は、30秒〜1分待ってから再試行
- [ ] 問題が解決しない場合は、バックエンドを再デプロイ

---

## 🆘 それでも解決しない場合

1. **Render.comのログを確認**
   - バックエンドの「Logs」タブでエラーログを確認
   - フロントエンドの「Logs」タブでビルドエラーを確認

2. **ローカル環境で確認**
   - ローカル環境でフロントエンドとバックエンドを起動
   - ローカル環境で動作する場合は、Render.comの設定の問題の可能性

3. **サポートに連絡**
   - Render.comのサポートに問い合わせ
   - または、開発チームに連絡

---

**最終更新**: 2025-12-01


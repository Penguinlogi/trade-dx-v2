# Phase 3: 差分同期機能

## 概要
30分ごとに個人ファイルの差分のみをマスターファイルに同期する機能を提供します。

## 主な機能
- ✅ 差分のみの効率的な同期
- ✅ 同期済みフラグの自動管理
- ✅ 新規案件の追加
- ✅ 既存案件の更新
- ✅ ファイルロック検知
- ✅ 詳細なログ出力
- ✅ 重複防止機能

## ファイル構成
```
scripts/phase3/
├── incremental_sync.py      # 差分同期スクリプト（約430行）
├── run_sync.bat              # Windows実行スクリプト
├── run_sync.sh               # Linux/Mac実行スクリプト
├── demo_manual_test.py       # 手動テストツール（約240行）
└── README.md                 # このファイル
```

## 使用方法

### 1. 手動実行

#### Windows
```bash
cd scripts\phase3
run_sync.bat
```

#### Linux/Mac
```bash
cd scripts/phase3
bash run_sync.sh
```

#### Pythonで直接実行
```bash
cd scripts/phase3
python incremental_sync.py
```

### 2. タスクスケジューラで自動実行（本番環境）

#### Windowsタスクスケジューラ
1. タスクスケジューラを開く
2. 基本タスクの作成
   - 名前: `貿易DX_差分同期`
   - トリガー: 毎日 00:00、繰り返し間隔 30分
   - 操作: プログラムの開始
     - プログラム: `python.exe`
     - 引数: `scripts\phase3\incremental_sync.py`
     - 開始: プロジェクトルートディレクトリ

## 動作の流れ

```
1. 各ユーザーの個人ファイルを確認
   ↓
2. 未同期データを抽出（同期済みフラグ = False）
   ↓
3. マスターファイルに反映
   - 新規案件 → 追加
   - 既存案件 → 更新
   ↓
4. 各個人ファイルの同期済みフラグを True に更新
   ↓
5. ログに記録
```

## 同期フラグについて

各個人ファイルには以下の2つの列が自動的に追加されます：

- **_同期済み**: True/False（同期済みかどうか）
- **_同期日時**: 最後に同期された日時

これらの列は自動管理されるため、ユーザーが手動で変更する必要はありません。

## ログファイル

ログファイルは以下の場所に出力されます：
```
logs/sync_YYYYMMDD.log
```

ログには以下の情報が記録されます：
- 同期開始・完了時刻
- 各ユーザーの未同期データ件数
- マスター更新件数
- エラー情報（発生した場合）

## エラーハンドリング

### ファイルロック
個人ファイルが開かれている（ロック中）場合、そのファイルはスキップされ、次回の実行時に同期されます。

### ファイルが存在しない
個人ファイルが存在しない場合、警告がログに記録されますが、処理は継続されます。

### マスターファイルへのアクセスエラー
マスターファイルへの書き込みに失敗した場合、エラーログが記録され、処理が終了します（終了コード: 1）

## テスト

### 単体テスト
```bash
cd "C:\Users\関伸\OneDrive - ペンギンロジスティクス株式会社\ドキュメント\ペンギンロジスティクス\e 営業部門\c AI事業部門\CURSOR\貿易DX"
python scripts\tests\test_phase3.py
```

### 手動テスト
```bash
cd scripts/phase3
python demo_manual_test.py
```

手動テストでは以下の6つのシナリオがテストされます：
1. 初期化とファイル確認
2. 未同期データの取得
3. 差分同期の実行
4. マスターファイルの確認
5. 同期フラグの確認
6. 2回目の同期（重複確認）

## パフォーマンス

- **処理時間**: 数秒（差分のみを処理）
- **ファイルロック時間**: 最小限（読み書き時のみ）
- **メモリ使用量**: 小（差分データのみをメモリに保持）

## 本番運用での推奨設定

1. **実行間隔**: 30分ごと
   - データロストリスクの削減
   - リアルタイム性の向上

2. **監視**:
   - ログファイルの定期確認
   - エラー発生時のアラート設定

3. **バックアップ**:
   - マスターファイルは自動バックアップあり
   - 個人ファイルは頻繁な更新のためバックアップなし

## トラブルシューティング

### Q: 同期が実行されない
A: 以下を確認してください：
- Pythonがインストールされているか
- 必要なライブラリ（pandas, openpyxl）がインストールされているか
- ファイルパスが正しいか

### Q: 同期済みデータが再度同期される
A: 同期フラグが正しく更新されていない可能性があります。ログファイルを確認してください。

### Q: ファイルがロックされているエラー
A: 個人ファイルが開かれている場合、スキップされます。次回の実行時に同期されます。

## 関連ドキュメント

- [全体設計書](../../全体設計書.md)
- [Phase 1: 基盤整備](../phase1/README.md)
- [フェーズ進捗メモ](../../進捗管理/フェーズ進捗メモ/フェーズ3.md)

## バージョン情報

- **Version**: 2.1
- **実装日**: 2025-11-20
- **テスト結果**: 7/7 passed
- **ステータス**: ✅ 完了

---

**更新日時**: 2025-11-20


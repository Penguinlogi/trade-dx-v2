# Phase 4: 統合処理改善 - 手動操作手順書

## 📋 目次

1. [概要](#概要)
2. [事前準備](#事前準備)
3. [テストデータの作成](#テストデータの作成)
4. [実行前のデータ確認](#実行前のデータ確認)
5. [スクリプトの実行](#スクリプトの実行)
6. [実行後のデータ確認](#実行後のデータ確認)
7. [確認チェックリスト](#確認チェックリスト)
8. [トラブルシューティング](#トラブルシューティング)

---

## 概要

Phase 4では、統合処理を改善し、以下の機能を実装しました：

### ✨ 新機能

1. **項目単位の競合解決**
   - 複数人が同じ案件の異なる項目を更新した場合でも、すべての変更を保持
   - データロストを防止

2. **ファイルロック検知とリトライ**
   - ファイルが開かれている場合を検知
   - 自動的に3回までリトライ（1分間隔）

3. **競合ログの出力**
   - どの項目で競合が発生したかをJSON形式で記録

### 🎯 動作確認の目標

- [ ] 項目単位のマージが正常に動作する
- [ ] 競合が適切に解決される
- [ ] ファイルロック時にリトライが動作する
- [ ] 競合ログが正しく出力される

---

## 事前準備

### 1. Phase 1-3の完了確認

Phase 4はPhase 1の共通モジュールに依存しています。

```bash
# Phase 1のファイルが存在するか確認
dir scripts\phase1\common.py
dir scripts\phase1\file_handler.py
dir scripts\phase1\config.json
```

### 2. 必要なディレクトリの確認

```bash
# ディレクトリが存在するか確認
dir master
dir work
dir backup
dir logs
```

### 3. Python環境の確認

```bash
python --version
# Python 3.7以上が必要

# 必要なライブラリの確認
python -c "import pandas; print('pandas:', pandas.__version__)"
python -c "import openpyxl; print('openpyxl: OK')"
```

---

## テストデータの作成

### シナリオ: 項目単位の競合解決テスト

**目的:** 山田さんが数量を更新し、鈴木さんが単価を更新した場合、両方の変更が反映されることを確認

### ステップ1: マスターファイルの準備

1. `master/案件管理台帳_マスター.xlsx` を開く
2. 「案件一覧」シートに以下のデータを入力（または既存データを使用）

| 案件番号 | 案件名 | 顧客名 | 数量 | 単価 | 最終更新日時 | 更新者 |
|---------|--------|--------|------|------|-------------|--------|
| 2025-EX-999 | テスト案件Phase4 | テスト株式会社 | 100 | 1000 | 2025-11-20 10:00:00 | システム |

3. 保存して閉じる

### ステップ2: 山田さんのファイル（数量を更新）

1. `work/案件管理台帳_マスター_yamada.xlsx` を開く（なければマスターをコピー）
2. 案件番号 `2025-EX-999` の**数量**を変更

| 案件番号 | 案件名 | 顧客名 | 数量 | 単価 | 最終更新日時 | 更新者 |
|---------|--------|--------|------|------|-------------|--------|
| 2025-EX-999 | テスト案件Phase4 | テスト株式会社 | **150** | 1000 | 2025-11-20 15:00:00 | 山田 |

3. 保存して閉じる

### ステップ3: 鈴木さんのファイル（単価を更新）

1. `work/案件管理台帳_マスター_suzuki.xlsx` を開く（なければマスターをコピー）
2. 案件番号 `2025-EX-999` の**単価**を変更

| 案件番号 | 案件名 | 顧客名 | 数量 | 単価 | 最終更新日時 | 更新者 |
|---------|--------|--------|------|------|-------------|--------|
| 2025-EX-999 | テスト案件Phase4 | テスト株式会社 | 100 | **1200** | 2025-11-20 15:30:00 | 鈴木 |

3. 保存して閉じる

### 📸 実行前のスナップショット

以下をメモしておきます：

```
【マスターファイル】
案件番号: 2025-EX-999
数量: 100
単価: 1000
最終更新日時: 2025-11-20 10:00:00

【山田さん】
案件番号: 2025-EX-999
数量: 150 ← 変更
単価: 1000
最終更新日時: 2025-11-20 15:00:00

【鈴木さん】
案件番号: 2025-EX-999
数量: 100
単価: 1200 ← 変更
最終更新日時: 2025-11-20 15:30:00
```

### 期待される結果

統合後、マスターファイルは以下のようになるはずです：

```
【期待される統合結果】
案件番号: 2025-EX-999
数量: 150  ← 山田さんの更新が反映
単価: 1200 ← 鈴木さんの更新が反映
最終更新日時: 2025-11-20 15:30:00（最新のタイムスタンプ）
更新者: 鈴木
```

**✅ V2.1では、両方の変更が保持されます！**

---

## 実行前のデータ確認

### 1. ファイルの存在確認

```bash
# マスターファイル
dir master\案件管理台帳_マスター.xlsx

# ユーザーファイル
dir work\案件管理台帳_マスター_yamada.xlsx
dir work\案件管理台帳_マスター_suzuki.xlsx
```

### 2. ファイルが閉じられているか確認

**⚠️ 重要:** すべてのExcelファイルを閉じてください。

- [ ] マスターファイルを閉じた
- [ ] 山田さんのファイルを閉じた
- [ ] 鈴木さんのファイルを閉じた

### 3. データ内容の確認

各ファイルを開いて、テストデータが正しく入力されているか確認します。

```python
# Pythonで確認する場合
python
>>> import pandas as pd
>>> df = pd.read_excel('master/案件管理台帳_マスター.xlsx', sheet_name='案件一覧')
>>> print(df[df['案件番号'] == '2025-EX-999'])
>>> exit()
```

---

## スクリプトの実行

### 方法1: バッチファイルから実行（推奨）

```cmd
cd scripts\phase4
run_integrate.bat
```

### 方法2: Python直接実行

```cmd
cd scripts\phase4
python integrate_data.py
```

### 方法3: プロジェクトルートから実行

```cmd
python scripts\phase4\integrate_data.py
```

### 実行時の出力例

```
======================================================================
統合処理スクリプト（V2.1 - 改良版）
Phase 4: 項目単位の競合解決とリトライ機構
======================================================================

======================================================================
統合処理開始（リトライ機能付き）
最大リトライ回数: 3
リトライ間隔: 60秒
======================================================================

試行 1/3
✓ 全ファイルがアクセス可能
============================================================
データ統合開始（V2.1 - 項目単位マージ）
============================================================
マスターデータ読み込み: 10件
ユーザーデータ読み込み (山田): 10件
ユーザーデータ読み込み (鈴木): 10件
============================================================
項目単位マージ開始（V2.1機能）
============================================================
競合検出: 2025-EX-999
  項目: 数量
    - システム: 100 (2025-11-20 10:00:00)
    - 山田: 150 (2025-11-20 15:00:00)
  → 採用: 山田の値
  項目: 単価
    - システム: 1000 (2025-11-20 10:00:00)
    - 鈴木: 1200 (2025-11-20 15:30:00)
  → 採用: 鈴木の値
マージ完了: 10件（競合: 1件）
============================================================
競合ログ保存: conflicts_20251120_170000.json
バックアップ作成: 案件管理台帳_マスター_backup_20251120_170000.xlsx
マスターデータ保存完了: 10件
統合完了: 10件
============================================================
✓ 統合成功
✓ 統合処理が正常に完了しました

======================================================================
✓ 統合処理が正常に完了しました
======================================================================
```

---

## 実行後のデータ確認

### 1. マスターファイルの確認

`master/案件管理台帳_マスター.xlsx` を開いて、案件番号 `2025-EX-999` を確認します。

**確認項目:**

| 項目 | 期待値 | 実際の値 | ✅/❌ |
|------|--------|---------|-------|
| 案件番号 | 2025-EX-999 | | |
| 数量 | 150（山田さんの更新） | | |
| 単価 | 1200（鈴木さんの更新） | | |
| 更新者 | 鈴木 | | |

✅ **両方の更新が反映されていれば成功！**

### 2. バックアップファイルの確認

統合前のマスターファイルがバックアップされているか確認します。

```cmd
dir backup\案件管理台帳_マスター_backup_*.xlsx
```

最新のバックアップファイルを開いて、統合前の状態が保存されているか確認します。

### 3. 競合ログの確認

競合が発生した場合、ログファイルが作成されます。

```cmd
dir logs\conflicts_*.json
```

最新の競合ログを開いて内容を確認します：

```json
[
  {
    "case_number": "2025-EX-999",
    "conflicts": [
      {
        "column": "数量",
        "values": [
          {
            "value": 100,
            "timestamp": "2025-11-20 10:00:00",
            "updater": "システム"
          },
          {
            "value": 150,
            "timestamp": "2025-11-20 15:00:00",
            "updater": "山田"
          }
        ],
        "selected": {
          "value": 150,
          "timestamp": "2025-11-20 15:00:00",
          "updater": "山田"
        }
      },
      {
        "column": "単価",
        "values": [
          {
            "value": 1000,
            "timestamp": "2025-11-20 10:00:00",
            "updater": "システム"
          },
          {
            "value": 1200,
            "timestamp": "2025-11-20 15:30:00",
            "updater": "鈴木"
          }
        ],
        "selected": {
          "value": 1200,
          "timestamp": "2025-11-20 15:30:00",
          "updater": "鈴木"
        }
      }
    ],
    "timestamp": "2025-11-20T17:00:00"
  }
]
```

### 4. 実行ログの確認

```cmd
type logs\integrate_20251120.log
```

エラーがないか確認します。

---

## 確認チェックリスト

### ✅ 基本動作確認

- [ ] **スクリプトが正常に起動する**
  - エラーなく実行完了

- [ ] **マスターファイルが更新される**
  - 統合後のデータが反映されている

- [ ] **バックアップが作成される**
  - `backup/` ディレクトリに新しいバックアップファイルがある

- [ ] **ログファイルが作成される**
  - `logs/integrate_*.log` が作成されている

### ✅ 項目単位マージの確認

- [ ] **異なる項目の更新がすべて反映される**
  - 山田さんの数量更新（100 → 150）が反映
  - 鈴木さんの単価更新（1000 → 1200）が反映
  - **両方が保持されている**

- [ ] **同じ項目への更新は最新が採用される**
  - 複数人が同じ項目を更新した場合、最新のタイムスタンプが採用される

### ✅ 競合ログの確認

- [ ] **競合ログが出力される**
  - `logs/conflicts_*.json` が作成されている

- [ ] **競合の内容が正しく記録される**
  - 案件番号、項目名、各ユーザーの値、採用された値が記録されている

### ✅ ファイルロック対応の確認

テスト方法：
1. マスターファイルをExcelで開いたままにする
2. スクリプトを実行
3. リトライメッセージが表示されることを確認
4. Excelを閉じる
5. 次のリトライで成功することを確認

- [ ] **ファイルロックが検知される**
  - 「ファイルがロック中」というメッセージが表示される

- [ ] **自動リトライが動作する**
  - 60秒後にリトライが実行される

- [ ] **リトライ後に成功する**
  - ファイルを閉じた後、統合が成功する

### ✅ エラーハンドリングの確認

- [ ] **存在しないファイルのエラーハンドリング**
  - 適切なエラーメッセージが表示される

- [ ] **データ形式エラーのハンドリング**
  - 不正なデータでもクラッシュしない

---

## トラブルシューティング

### ❌ エラー1: `ModuleNotFoundError: No module named 'pandas'`

**原因:** 必要なライブラリがインストールされていません。

**解決方法:**
```cmd
pip install pandas openpyxl
```

### ❌ エラー2: `FileNotFoundError: config.json`

**原因:** 設定ファイルが見つかりません。

**解決方法:**
```cmd
# Phase 1のconfig.jsonが存在するか確認
dir scripts\phase1\config.json

# 存在しない場合は、Phase 1を先に完了させる
```

### ❌ エラー3: 「ファイルがロック中」が3回続いて失敗

**原因:** マスターファイルまたはユーザーファイルがExcelで開かれています。

**解決方法:**
1. すべてのExcelファイルを閉じる
2. タスクマネージャーでExcelプロセスを確認し、必要に応じて終了
3. スクリプトを再実行

### ❌ エラー4: 統合後のデータが期待と異なる

**原因:** テストデータの設定が正しくない可能性があります。

**解決方法:**
1. バックアップから復元
2. テストデータを再度確認して設定
3. 競合ログを確認して、どの値が採用されたか確認

### ❌ エラー5: 競合ログが作成されない

**原因:** 競合が発生していない可能性があります。

**確認方法:**
- 実行ログで「競合検出」というメッセージがあるか確認
- テストデータで本当に競合が発生する設定になっているか確認
  - 同じ案件番号のデータが複数のファイルに存在するか
  - 値が異なっているか

### ❌ エラー6: メール通知が届かない

**原因:** メール設定が正しくない、またはSMTPサーバーに接続できません。

**解決方法:**
1. `scripts/phase1/config.json` のメール設定を確認
2. SMTPサーバーの接続を確認
3. 現時点ではメール機能はオプションなので、動作確認には影響しません

---

## 🎉 動作確認完了の判定

以下がすべて ✅ であれば、Phase 4の動作確認は完了です：

### 必須項目

- [x] スクリプトが正常に実行できる
- [x] 項目単位のマージが正しく動作する
  - 異なる項目の更新がすべて反映される
  - 同じ項目の更新は最新が採用される
- [x] 競合ログが正しく出力される
- [x] バックアップが正常に作成される
- [x] ファイルロック時にリトライが動作する

### オプション項目

- [ ] メール通知が動作する（環境により不要）
- [ ] 複数回実行しても安定している
- [ ] 大量データでも正常に動作する

---

## 次のステップ

Phase 4の動作確認が完了したら：

1. **全体進捗管理書を更新**
   - Phase 4を「完了」に更新

2. **Gitコミット**
   ```bash
   git add scripts/phase4/
   git commit -m "Phase 4: 統合処理改善完了"
   git tag phase4-complete
   ```

3. **Phase 5へ進む**
   - Phase 5: 監視システムの実装

---

## 補足資料

### V2.0とV2.1の比較表

| 項目 | V2.0 | V2.1 |
|------|------|------|
| マージ方式 | 行単位（最新の行をまるごと採用） | 項目単位（各項目ごとに最新を採用） |
| データロスト | あり（異なる項目を更新した場合） | なし |
| 競合ログ | なし | JSON形式で出力 |
| ファイルロック対応 | なし | リトライ機構あり |
| アラート | なし | メール通知あり（オプション） |

### 参考資料

- [全体設計書](../../全体設計書.md) - 5.7章「項目単位の競合解決機能」
- [Phase 4 README](./README.md)
- [Phase 1 README](../phase1/README.md)

---

**作成日:** 2025-11-20  
**バージョン:** V2.1  
**作成者:** 貿易DX開発チーム



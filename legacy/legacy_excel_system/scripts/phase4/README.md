# Phase 4: 統合処理改善

## 概要

Phase 4では、データ統合処理を改善し、以下の機能を追加しました：

1. **項目単位の競合解決** - V2.1の新機能
2. **ファイルロック検知とリトライ機構**
3. **競合ログの自動出力**

## V2.0からの改善点

### 問題点（V2.0）

V2.0では「最新タイムスタンプの行をまるごと採用」していたため、以下の問題がありました：

**例：**
- 15:00 山田さん: 案件2025-EX-001の**数量**を更新（100 → 150）
- 15:30 鈴木さん: 同じ案件の**単価**を更新（1000 → 1200）

**結果（V2.0）：**
- 最新タイムスタンプ = 15:30 → 鈴木さんのデータをまるごと採用
- ✓ 単価: 1200（反映）
- ✗ 数量: 100（山田さんの更新が消える！）

### 改善（V2.1）

**項目単位のマージ**により、各項目ごとに最新の値を採用：

**結果（V2.1）：**
- ✓ 単価: 1200（鈴木さんの更新）
- ✓ 数量: 150（山田さんの更新）
- **両方の変更が保持される！**

## ファイル構成

```
scripts/phase4/
├── integrate_data.py      # 統合処理メインスクリプト
├── run_integrate.bat      # Windows実行スクリプト
├── run_integrate.sh       # Linux/Mac実行スクリプト
└── README.md             # このファイル
```

## 使用方法

### Windows

```cmd
cd scripts\phase4
run_integrate.bat
```

### Linux/Mac

```bash
cd scripts/phase4
chmod +x run_integrate.sh
./run_integrate.sh
```

### Python直接実行

```bash
cd scripts/phase4
python integrate_data.py
```

## 主な機能

### 1. 項目単位の競合解決

- 同じ案件を複数人が更新した場合、各項目ごとに最新の値を採用
- タイムスタンプを基準に自動判定
- データロストを防止

### 2. ファイルロック検知とリトライ

- ファイルが開かれている場合を自動検知
- 最大3回まで自動リトライ（1分間隔）
- リトライ失敗時はアラートメール送信

### 3. 競合ログ

競合が発生した場合、以下の情報をJSON形式で保存：

```json
[
  {
    "case_number": "2025-EX-001",
    "conflicts": [
      {
        "column": "数量",
        "values": [
          {"value": 150, "timestamp": "2025-11-20 15:00:00", "updater": "山田"},
          {"value": 180, "timestamp": "2025-11-20 15:30:00", "updater": "鈴木"}
        ],
        "selected": {"value": 180, "timestamp": "2025-11-20 15:30:00", "updater": "鈴木"}
      }
    ],
    "timestamp": "2025-11-20T17:30:00"
  }
]
```

保存場所: `logs/conflicts_YYYYmmdd_HHMMSS.json`

## 処理フロー

1. **ファイルロックチェック**
   - マスターファイルと各ユーザーファイルをチェック
   - ロックされている場合はリトライ

2. **データ読み込み**
   - マスターデータを読み込み
   - 各ユーザーのデータを読み込み

3. **項目単位マージ**
   - 案件番号でグループ化
   - 各項目ごとに最新のタイムスタンプを持つ値を採用
   - 競合が発生した場合はログに記録

4. **バックアップ作成**
   - 統合前のマスターファイルをバックアップ

5. **マスターファイル更新**
   - マージ結果をマスターファイルに保存

## 設定

`scripts/phase1/config.json` で以下を設定できます：

```json
{
  "file_settings": {
    "file_lock_retry": 3,        // 最大リトライ回数
    "file_lock_wait": 60         // リトライ間隔（秒）
  },
  "email_settings": {
    "smtp_server": "smtp.example.com",
    "smtp_port": 587,
    "from_address": "tradedx@example.com",
    "alert_recipients": ["admin@example.com"]
  }
}
```

## ログファイル

統合処理のログは以下の場所に保存されます：

- 実行ログ: `logs/integrate_YYYYmmdd.log`
- 競合ログ: `logs/conflicts_YYYYmmdd_HHMMSS.json`

## エラーハンドリング

### ファイルロックエラー

ファイルが開かれている場合：
1. 1分間待機してリトライ
2. 最大3回までリトライ
3. 失敗した場合はアラートメール送信

### その他のエラー

- すべてのエラーはログファイルに記録
- 致命的エラーの場合はアラートメール送信

## テスト

テストの実行：

```bash
cd scripts/tests
python test_phase4.py
```

## トラブルシューティング

### Q: 統合処理が失敗する

**A:** 以下を確認してください：
1. ログファイル（`logs/integrate_*.log`）を確認
2. ファイルが開かれていないか確認
3. ファイルのパスと権限を確認

### Q: 競合が多発する

**A:** 
1. 競合ログ（`logs/conflicts_*.json`）を確認
2. ユーザーに更新時のルールを周知
3. 30分ごとの差分同期（Phase 3）を有効化

### Q: メール通知が届かない

**A:**
1. `config.json`のメール設定を確認
2. SMTPサーバーの接続を確認
3. ファイアウォール設定を確認

## 関連ドキュメント

- [Phase 1: 基盤整備](../phase1/README.md)
- [Phase 3: 差分同期機能](../phase3/README.md)
- [全体設計書](../../全体設計書.md)

## バージョン履歴

- **V2.1** (2025-11-20)
  - 項目単位の競合解決機能を追加
  - ファイルロック検知とリトライ機構を追加
  - 競合ログ出力機能を追加

## ライセンス

社内利用限定



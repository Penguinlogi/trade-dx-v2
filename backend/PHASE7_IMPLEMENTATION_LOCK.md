# Phase 7: 変更履歴・バックアップ機能 - 実装ロック状態

**作成日**: 2025-11-28
**状態**: ✅ 実行確認完了 - 完全ロック中
**実行確認完了日**: 2025-11-28

## 📌 ロック対象機能

### 1. 変更履歴機能

#### 1.1 変更履歴の記録機能
- **ファイル**: `backend/app/services/change_history_service.py`
- **機能**: 案件の作成・更新・削除時に変更履歴を記録
- **状態**: ✅ 正常動作確認済み

#### 1.2 変更履歴API
- **ファイル**: `backend/app/api/endpoints/change_history.py`
- **機能**:
  - 変更履歴の取得、表示
  - 日本標準時変換
  - 案件番号による部分一致検索
  - 案件番号によるソート
- **状態**: ✅ 正常動作確認済み

#### 1.3 変更履歴モデル
- **ファイル**: `backend/app/models/change_history.py`
- **状態**: ✅ 正常動作確認済み

#### 1.4 案件削除処理
- **ファイル**: `backend/app/api/endpoints/cases.py`
- **機能**: 案件削除時の履歴記録
- **状態**: ✅ 正常動作確認済み

#### 1.5 変更履歴UI
- **ファイル**: `frontend/src/pages/ChangeHistoryPage.tsx`
- **機能**:
  - 変更履歴一覧表示
  - フィルタリング・ソート
  - 差分表示
  - _case_number_snapshotフィールドの非表示
- **状態**: ✅ 正常動作確認済み

### 2. バックアップ機能

#### 2.1 バックアップサービス
- **ファイル**: `backend/app/services/backup_service.py`
- **機能**:
  - バックアップ作成
  - バックアップ復元（ステータス更新含む）
  - 古いバックアップのクリーンアップ
- **状態**: ✅ 正常動作確認済み

#### 2.2 バックアップAPI
- **ファイル**: `backend/app/api/endpoints/backups.py`
- **機能**:
  - バックアップ作成・取得・削除
  - バックアップ復元
  - スケジュールバックアップ実行
  - 日本標準時変換（作成日時）
- **状態**: ✅ 正常動作確認済み

#### 2.3 バックアップモデル
- **ファイル**: `backend/app/models/backup.py`
- **状態**: ✅ 正常動作確認済み

#### 2.4 バックアップUI
- **ファイル**: `frontend/src/pages/BackupsPage.tsx`
- **機能**:
  - バックアップ一覧表示
  - バックアップ作成・復元・削除
  - フィルタリング・ソート
- **状態**: ✅ 正常動作確認済み

### 3. その他の関連機能

#### 3.1 ダッシュボードへの変更履歴アイコン追加
- **ファイル**: `frontend/src/pages/DashboardPage.tsx`
- **状態**: ✅ 正常動作確認済み

#### 3.2 案件フォームの日付フィールド修正
- **ファイル**: `frontend/src/components/Modal/CaseFormModal.tsx`
- **機能**: 年の入力制限（4桁）
- **状態**: ✅ 正常動作確認済み

## 🔒 ロック内容

以下の機能は**Phase 7完了後、変更禁止**です：

1. ✅ **削除履歴の記録**: 案件削除時に変更履歴が正しく記録される
2. ✅ **案件番号スナップショット**: 履歴表示時に正しい案件番号が表示される
3. ✅ **日本標準時変換**: 変更日時・作成日時がJST（UTC+9）で表示される
4. ✅ **履歴の永続化**: 案件削除後も変更履歴が残る
5. ✅ **変更履歴フィルタリング・ソート**: 案件番号による部分一致検索・ソート
6. ✅ **バックアップ復元**: 復元処理とステータス更新
7. ✅ **バックアップ日時表示**: 日本標準時での表示

## 📝 実装の要点

### 変更履歴機能

#### 案件番号スナップショット機能
- 変更履歴記録時に `case_number_snapshot` を `changes_json["_case_number_snapshot"]` に保存
- 履歴表示時にスナップショットを最優先で使用
- `_case_number_snapshot` フィールドは表示から除外
- これにより、案件削除や番号変更後も過去履歴が正しく表示される

#### 削除履歴の記録
- 案件削除前に変更履歴を記録
- 削除履歴を確実にコミット（案件削除とは別トランザクション）
- エラーハンドリングで詳細なログを記録
- `passive_deletes=True` で履歴が削除されないように設定

#### 日本標準時変換
- `to_jst()` 関数でUTCからJST（UTC+9）に変換
- すべての変更日時がJSTで表示される

#### 案件番号による検索・ソート
- 部分一致検索に対応
- ソート項目として案件番号を選択可能
- Python側でのフィルタリング・ソート処理

### バックアップ機能

#### バックアップ作成
- ステータス管理（in_progress → success/failed）
- ファイルサイズ・レコード数の記録

#### バックアップ復元
- 復元開始時にステータスを「in_progress」に更新
- 復元完了時にステータスを「success」に更新
- エラー時は「failed」に更新
- 安全のため復元前に現在のDBをバックアップ

#### 日本標準時変換
- 作成日時をJSTに変換して表示

## ⚠️ 変更時の注意事項

この機能を変更する場合は：

1. **必ずバックアップを取る**
2. **変更内容を詳細に記録する**
3. **変更後は必ずテストを実施する**
4. **以下の重要機能を確認する**:
   - 削除履歴の記録
   - 案件番号スナップショット
   - JST変換（変更履歴・バックアップ）
   - バックアップ復元のステータス更新

## 🔍 検証項目（全て確認済み）

### 変更履歴機能
- [x] 案件作成時に変更履歴が記録される
- [x] 案件更新時に変更履歴が記録される
- [x] 案件削除時に変更履歴が記録される
- [x] 変更履歴に正しい案件番号が表示される（過去履歴が書き換わらない）
- [x] 変更日時が日本標準時で表示される
- [x] 案件削除後も変更履歴が残る
- [x] 案件番号による部分一致検索が動作する
- [x] 案件番号によるソートが動作する
- [x] _case_number_snapshotフィールドが非表示になっている

### バックアップ機能
- [x] 手動バックアップが作成できる
- [x] バックアップファイルがディスクに保存される
- [x] バックアップ一覧が正しく表示される
- [x] バックアップのステータスが正しく表示される
- [x] ファイルサイズとレコード数が正しく表示される
- [x] バックアップから復元ができる
- [x] 復元後のデータが正しい
- [x] 復元後にステータスが正しく更新される
- [x] バックアップの削除ができる
- [x] スケジュールバックアップが作成できる
- [x] 古いバックアップのクリーンアップが動作する
- [x] 作成日時が日本標準時で表示される

## 📂 関連ファイル

```
backend/
├── app/
│   ├── api/endpoints/
│   │   ├── cases.py                    # 案件CRUD（削除履歴記録含む）
│   │   ├── change_history.py           # 変更履歴API（JST変換、案件番号検索・ソート）
│   │   └── backups.py                  # バックアップAPI（JST変換、復元ステータス更新）
│   ├── models/
│   │   ├── case.py                      # 案件モデル（passive_deletes=True）
│   │   ├── change_history.py           # 変更履歴モデル
│   │   └── backup.py                    # バックアップモデル
│   ├── services/
│   │   ├── change_history_service.py    # 変更履歴記録サービス
│   │   ├── backup_service.py            # バックアップサービス（復元ステータス更新）
│   │   └── scheduler_service.py         # スケジューラーサービス
│   └── schemas/
│       ├── change_history.py            # 変更履歴スキーマ
│       └── backup.py                    # バックアップスキーマ
└── scripts/
    └── fix_change_history_case_number_snapshot.py  # 既存データ補正スクリプト

frontend/
└── src/
    ├── pages/
    │   ├── ChangeHistoryPage.tsx        # 変更履歴画面（案件番号検索・ソート、_case_number_snapshot非表示）
    │   ├── BackupsPage.tsx              # バックアップ管理画面
    │   └── DashboardPage.tsx            # ダッシュボード（変更履歴アイコン追加）
    ├── components/
    │   └── Modal/
    │       └── CaseFormModal.tsx        # 案件フォーム（日付フィールド修正）
    ├── api/
    │   ├── changeHistory.ts             # 変更履歴API
    │   └── backups.ts                   # バックアップAPI
    └── types/
        ├── changeHistory.ts             # 変更履歴型定義
        └── backup.ts                    # バックアップ型定義
```

## 🚫 変更禁止期間

**Phase 7完了後、Phase 8以降の開発まで**: この機能に関する変更は行わない

---

**最終更新**: 2025-11-28
**ロック状態**: 🔒 完全ロック有効
**実行確認者**: システム管理者
**次フェーズ**: Phase 8 - リアルタイム同期・通知







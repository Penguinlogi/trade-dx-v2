# マイグレーション履歴の記録手順

## 問題: "table users already exists"

このエラーは、データベースに既にテーブルが存在するが、Alembicのマイグレーション履歴が記録されていないことを示しています。

## 解決方法

### ステップ1: データベースを最新のマイグレーション状態としてマーク

既存のデータベースに対して、マイグレーション履歴を記録します：

```bash
cd backend
venv\Scripts\activate.bat
python -m alembic stamp head
```

または、バッチファイルを使用：

```bash
cd backend
stamp_migration.bat
```

これで、データベースを最新のマイグレーション状態（001）としてマークします。

### ステップ2: 新しいマイグレーションを作成（必要に応じて）

既存のマイグレーションを適用した後、新しいマイグレーションを作成できます：

```bash
python -m alembic revision --autogenerate -m "make_change_history_case_id_nullable"
python -m alembic upgrade head
```

## 重要: マイグレーションなしでも動作する可能性

SQLiteでは外部キー制約がデフォルトで無効のため、マイグレーションなしでも削除処理は動作する可能性があります。

まず、マイグレーションを実行せずに以下を確認してください：

1. バックエンドサーバーを再起動
2. 案件を削除して動作確認
3. 変更履歴ページで削除履歴が1件のみ表示されることを確認

問題が続く場合は、バックエンドのログに表示されるエラーメッセージを共有してください。







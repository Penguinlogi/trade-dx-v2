# Phase 8: リアルタイム同期・通知 - 手動操作手順書

## 📋 目次
1. [概要](#概要)
2. [実行前の準備](#実行前の準備)
3. [WebSocket接続確認](#websocket接続確認)
4. [リアルタイム更新の動作確認](#リアルタイム更新の動作確認)
5. [複数ユーザーでの同時接続確認](#複数ユーザーでの同時接続確認)
6. [通知機能の確認](#通知機能の確認)
7. [接続切断時の動作確認](#接続切断時の動作確認)
8. [確認チェックリスト](#確認チェックリスト)
9. [トラブルシューティング](#トラブルシューティング)

---

## 概要

Phase 8では、以下の機能が実装されました：
- **WebSocket接続**: リアルタイム通信の確立
- **リアルタイム更新通知**: 案件・顧客・商品の更新をリアルタイムで通知
- **サーバー状態表示**: 接続状態、オンラインユーザー数、最終同期時刻を表示
- **自動再接続**: 接続切断時の自動再接続機能

---

## 実行前の準備

### 1. サーバー起動

#### バックエンドサーバー起動

**方法1: バッチファイルで起動（Windows・推奨）**

既存の `start_server.bat` を使用（仮想環境のアクティベートが自動で行われます）：

**コマンドプロンプト（cmd）を使用する場合**:
```batch
cd backend
start_server.bat
```

**PowerShellを使用する場合**:
```powershell
cd backend
.\start_server.bat
```

**注意**: PowerShellでは、現在のディレクトリのファイルを実行する際に `.\` を付ける必要があります。

**方法2: コマンドプロンプトから手動で起動**

仮想環境をアクティベートしてから起動：

```batch
cd backend
venv\Scripts\activate.bat
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**注意**: 仮想環境をアクティベートしないと `ModuleNotFoundError: No module named 'fastapi'` エラーが発生します。

**方法3: PowerShellから起動**

```powershell
cd backend
.\venv\Scripts\Activate.ps1
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**PowerShellで実行ポリシーエラーが出る場合**:

```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

#### フロントエンドサーバー起動

**方法1: npmコマンドで起動**

```bash
cd frontend
npm run dev
```

**方法2: バッチファイルで起動（Windows）**

既存の `start_frontend.bat` を使用：

```batch
cd frontend
start_frontend.bat
```

### 2. ブラウザでアクセス

- フロントエンド: http://localhost:3000
- バックエンドAPI: http://localhost:8000
- APIドキュメント: http://localhost:8000/docs

### 3. テストデータの準備

#### シードデータの投入（初回のみ）

データベースにユーザーやマスタデータが存在しない場合、シードデータを投入してください：

**推奨方法: バッチファイルを使用**

```batch
cd backend
scripts\run_seed_with_venv.bat
```

**手動で実行する場合**:

```batch
cd backend
venv\Scripts\activate.bat
python scripts\seed_data.py
```

**注意**: 仮想環境をアクティベートしないと `ModuleNotFoundError` エラーが発生します。

これで以下のユーザーが作成されます：
- **ユーザー名**: `admin` / **パスワード**: `admin123`
- **ユーザー名**: `yamada` / **パスワード**: `yamada123`
- **ユーザー名**: `suzuki` / **パスワード**: `suzuki123`

#### 新規データの作成

既存のテストデータを使用するか、以下の手順で新規データを作成：

1. ログイン（上記のユーザーでログイン）
2. 案件管理画面で新規案件を作成
3. 顧客マスタ画面で新規顧客を作成
4. 商品マスタ画面で新規商品を作成

---

## WebSocket接続確認

### 手順1: ログインして接続状態を確認

1. ブラウザで http://localhost:3000 にアクセス
2. ログイン画面で既存ユーザーでログイン
3. ダッシュボード画面の右上にサーバー状態表示が表示されることを確認
   - **期待される表示**:
     - オンライン/オフラインのステータス
     - 接続ユーザー数
     - 最終同期時刻

### 手順2: ブラウザの開発者ツールで接続を確認

1. ブラウザの開発者ツールを開く（F12キー）
2. 「Console」タブを開く
3. 以下のメッセージが表示されることを確認：
   ```
   WebSocket接続が確立されました
   ```

### 手順3: ネットワークタブでWebSocket接続を確認

1. 開発者ツールの「Network」タブを開く
2. フィルターで「Socket」タブをクリック（または「WS」フィルターを選択）
3. WebSocket接続が表示されることを確認
   - **確認ポイント**:
     - **Name列**: `ws?token=...` という形式で表示される（`/api/ws` のパスが含まれている）
     - **Status列**: `101` と表示される（HTTP 101 Switching Protocols）
     - **Type列**: `websocket` と表示される
     - **Initiator列**: `useWebSocket.ts:76` など、接続元のファイル名が表示される
4. 接続のステータスが「101 Switching Protocols」であることを確認
   - **注意**: 複数の接続が表示される場合がありますが、これはReactの開発モードでの二重レンダリングによるものです。最終的に1つの接続が確立されれば問題ありません。

---

## リアルタイム更新の動作確認

### テストシナリオ1: 案件更新の通知

**準備**: 2つのブラウザウィンドウ（または2つのブラウザ）を開く

**手順**:

1. **ウィンドウ1**: ログインして案件管理画面を開く
2. **ウィンドウ2**: 同じユーザーでログインして案件管理画面を開く
3. **ウィンドウ1**: 既存の案件を編集（例: 数量を変更）
4. **ウィンドウ2**: 右上に通知が表示されることを確認
   - **期待される通知**: 「案件が更新されました」
5. **ウィンドウ2**: 案件一覧が自動的に更新されることを確認

### テストシナリオ2: 案件作成の通知

**手順**:

1. **ウィンドウ1**: 新規案件を作成
2. **ウィンドウ2**: 通知が表示され、一覧が自動更新されることを確認

### テストシナリオ3: 案件削除の通知

**手順**:

1. **ウィンドウ1**: 既存の案件を削除
2. **ウィンドウ2**: 通知が表示され、一覧から削除された案件が消えることを確認

---

## 複数ユーザーでの同時接続確認

### 手順1: 複数ユーザーでログイン

1. **ユーザー1**: ブラウザ1でログイン
2. **ユーザー2**: ブラウザ2（または別のブラウザ）でログイン

### 手順2: 接続ユーザー数の確認

1. 各ユーザーのダッシュボード画面でサーバー状態を確認
2. **期待される表示**: 接続ユーザー数が「2人接続」と表示される

### 手順3: ユーザー接続/切断通知の確認

1. **ユーザー1**: ブラウザを閉じる（またはログアウト）
2. **ユーザー2**: 通知が表示されることを確認
   - **期待される通知**: 「[ユーザー名]が切断しました」
3. **ユーザー1**: 再度ログイン
4. **ユーザー2**: 通知が表示されることを確認
   - **期待される通知**: 「[ユーザー名]が接続しました」

---

## 通知機能の確認

### 通知タイプの確認

以下の操作を行い、それぞれの通知が正しく表示されることを確認：

1. **案件更新通知**
   - 案件を作成 → 「案件が作成されました」
   - 案件を更新 → 「案件が更新されました」
   - 案件を削除 → 「案件が削除されました」

2. **顧客マスタ更新通知**（実装済みの場合）
   - 顧客を作成 → 「顧客マスタが追加されました」
   - 顧客を更新 → 「顧客マスタが更新されました」
   - 顧客を削除 → 「顧客マスタが削除されました」

3. **商品マスタ更新通知**（実装済みの場合）
   - 商品を作成 → 「商品マスタが追加されました」
   - 商品を更新 → 「商品マスタが更新されました」
   - 商品を削除 → 「商品マスタが削除されました」

4. **ドキュメント生成通知**（実装済みの場合）
   - ドキュメントを生成 → 「ドキュメントが生成されました」

5. **バックアップ作成通知**（実装済みの場合）
   - バックアップを作成 → 「バックアップが作成されました」

### 通知の表示位置と動作確認

1. 通知は画面右上に表示されることを確認
2. 通知は5秒後に自動的に閉じることを確認
3. 通知の「×」ボタンで手動で閉じることができることを確認

---

## 接続切断時の動作確認

### テストシナリオ1: サーバー停止時の動作

**手順**:

1. ブラウザでログインして接続を確立
2. バックエンドサーバーを停止（Ctrl+C）
3. ブラウザのコンソールで以下のメッセージが表示されることを確認：
   ```
   WebSocket接続が切断されました
   ```
4. サーバー状態表示が「オフライン」に変わることを確認
5. バックエンドサーバーを再起動
6. 3秒後に自動的に再接続されることを確認
7. サーバー状態表示が「オンライン」に戻ることを確認

### テストシナリオ2: ネットワーク切断時の動作

**手順**:

1. ブラウザでログインして接続を確立
2. ネットワーク接続を一時的に切断（Wi-Fiをオフにするなど）
3. サーバー状態表示が「オフライン」に変わることを確認
4. ネットワーク接続を復旧
5. 自動的に再接続されることを確認

### テストシナリオ3: ログアウト時の動作

**手順**:

1. ブラウザでログインして接続を確立
2. ログアウトボタンをクリック
3. WebSocket接続が切断されることを確認
4. サーバー状態表示が消えることを確認

---

## 確認チェックリスト

### WebSocket接続
- [ ] ログイン時にWebSocket接続が確立される
- [ ] サーバー状態表示が正しく表示される
- [ ] ブラウザのコンソールに接続メッセージが表示される
- [ ] ネットワークタブでWebSocket接続が確認できる

### リアルタイム更新
- [ ] 案件作成時に通知が表示される
- [ ] 案件更新時に通知が表示される
- [ ] 案件削除時に通知が表示される
- [ ] 他のユーザーの操作で一覧が自動更新される

### 複数ユーザー接続
- [ ] 複数ユーザーで同時接続できる
- [ ] 接続ユーザー数が正しく表示される
- [ ] ユーザー接続/切断通知が表示される

### 通知機能
- [ ] 通知が画面右上に表示される
- [ ] 通知が5秒後に自動的に閉じる
- [ ] 通知を手動で閉じることができる
- [ ] 各操作タイプに応じた通知が表示される

### 接続切断時の動作
- [ ] サーバー停止時に「オフライン」と表示される
- [ ] サーバー再起動時に自動再接続される
- [ ] ネットワーク切断時に「オフライン」と表示される
- [ ] ネットワーク復旧時に自動再接続される
- [ ] ログアウト時に接続が切断される

---

## トラブルシューティング

### 問題0: `ModuleNotFoundError: No module named 'fastapi'` エラー

**症状**: バックエンドサーバー起動時に `ModuleNotFoundError: No module named 'fastapi'` エラーが発生する

**原因**: 仮想環境がアクティベートされていない状態でサーバーを起動しようとした

**解決方法**:

1. **方法1（推奨）: バッチファイルを使用**
   ```batch
   cd backend
   start_server.bat
   ```
   このバッチファイルは仮想環境のアクティベートを自動で行います。

2. **方法2: 手動で仮想環境をアクティベート**
   ```batch
   cd backend
   venv\Scripts\activate.bat
   python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

3. **方法3: ライブラリがインストールされていない場合**
   仮想環境をアクティベートした後、必要なライブラリをインストール：
   ```batch
   cd backend
   venv\Scripts\activate.bat
   pip install -r requirements.txt
   ```

**確認方法**:
仮想環境が正しくアクティベートされているか確認：
```batch
python --version
pip list | findstr fastapi
```
`fastapi` が表示されれば、仮想環境が正しくアクティベートされています。

---

### 問題1: WebSocket接続が確立されない

**症状**: サーバー状態表示が「オフライン」のまま、接続できない

**確認事項**:
1. バックエンドサーバーが起動しているか確認
2. ブラウザのコンソールでエラーメッセージを確認
3. ネットワークタブでWebSocket接続のエラーを確認

**解決方法**:
- バックエンドサーバーを再起動
- ブラウザをリロード
- トークンが有効か確認（再ログイン）

### 問題2: 通知が表示されない

**症状**: 操作を行っても通知が表示されない

**確認事項**:
1. WebSocket接続が確立されているか確認
2. ブラウザのコンソールでエラーメッセージを確認
3. 通知コンポーネントが正しくレンダリングされているか確認

**解決方法**:
- ブラウザをリロード
- WebSocket接続を確認
- 開発者ツールでエラーを確認

### 問題3: 自動更新が動作しない

**症状**: 通知は表示されるが、一覧が自動更新されない

**確認事項**:
1. ブラウザのコンソールでエラーメッセージを確認
2. ネットワークタブでAPIリクエストが送信されているか確認

**解決方法**:
- ページをリロード
- ブラウザのキャッシュをクリア
- 開発者ツールでエラーを確認

### 問題4: 接続ユーザー数が正しく表示されない

**症状**: 接続ユーザー数が「0人接続」のまま、または正しくない

**確認事項**:
1. 複数のブラウザで接続しているか確認
2. サーバー側のログで接続数を確認

**解決方法**:
- ブラウザをリロード
- サーバーを再起動
- 接続を一度切断して再接続

### 問題5: 自動再接続が動作しない

**症状**: サーバー停止後に自動再接続されない

**確認事項**:
1. ブラウザのコンソールで再接続の試行ログを確認
2. サーバーが再起動されているか確認

**解決方法**:
- ブラウザをリロード
- 手動で再接続（ページをリロード）

---

## 補足情報

### WebSocket接続の仕様

- **接続URL**: `ws://localhost:8000/api/ws?token=[JWTトークン]`
- **ハートビート間隔**: 30秒
- **再接続間隔**: 3秒
- **サーバー状態取得間隔**: 60秒

### 通知の種類

- `case_updated`: 案件の作成・更新・削除
- `customer_updated`: 顧客マスタの作成・更新・削除
- `product_updated`: 商品マスタの作成・更新・削除
- `document_generated`: ドキュメントの生成
- `backup_created`: バックアップの作成
- `user_connected`: ユーザーの接続
- `user_disconnected`: ユーザーの切断

### 開発者向け情報

- WebSocketメッセージはブラウザのコンソールで確認可能
- カスタムイベント `websocket:update` が発火される
- サーバー状態は `useWebSocket` フックで取得可能

---

**Phase 8の実装が完了しました！**
**リアルタイム同期・通知機能が正常に動作することを確認してください。**

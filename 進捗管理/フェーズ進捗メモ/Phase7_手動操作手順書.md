# Phase 7: 変更履歴・バックアップ - 手動操作手順書

## 📋 目次
1. [概要](#概要)
2. [実行前の準備](#実行前の準備)
3. [変更履歴機能の確認](#変更履歴機能の確認)
4. [バックアップ機能の確認](#バックアップ機能の確認)
5. [確認チェックリスト](#確認チェックリスト)
6. [トラブルシューティング](#トラブルシューティング)

---

## 概要

Phase 7では、以下の機能が実装されました：
- **変更履歴機能**: 案件の作成・更新・削除の履歴を自動記録
- **変更履歴表示**: 変更内容を一覧表示し、差分を確認可能
- **バックアップ機能**: データベースのバックアップを作成・管理
- **バックアップ復元**: バックアップからデータを復元

---

## 実行前の準備

### 1. サーバー起動

#### バックエンドサーバー起動

**方法1: コマンドプロンプトから起動**

```bash
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**方法2: バッチファイルで起動（Windows）**

バッチファイルを作成する場合：

```batch
@echo off
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
pause
```

#### フロントエンドサーバー起動

**方法1: npmコマンドで起動**

```bash
cd frontend
npm run dev
```

**方法2: バッチファイルで起動（Windows）**

```batch
@echo off
cd frontend
npm run dev
pause
```

### 2. データベースの確認

データベースファイルが存在することを確認：

```bash
cd backend
dir trade_dx.db
```

存在しない場合は、シードデータを投入：

```bash
python scripts/seed_data.py
```

### 3. テストデータの準備

#### 案件データの確認

ブラウザで以下のURLにアクセスして、案件が存在することを確認：

```
http://localhost:3000/cases
```

案件が存在しない場合は、以下の手順でテストデータを作成：

1. ログイン（デフォルトユーザー: `admin` / パスワード: `admin`）
2. 「案件管理」ページに移動
3. 「新規作成」ボタンをクリック
4. 以下のようなテストデータを入力：
   - 区分: 輸出
   - 顧客: 任意の顧客を選択
   - 商品: 任意の商品を選択
   - 数量: 100
   - 単位: 箱
   - 販売単価: 1000
   - 仕入単価: 800
   - ステータス: 見積中
   - 担当者: テスト担当者
5. 「保存」ボタンをクリック

---

## 変更履歴機能の確認

### 1. 実行前のデータ確認

変更履歴が記録されていることを確認：

1. ブラウザで以下にアクセス：
   ```
   http://localhost:3000/change-history
   ```
2. 既存の変更履歴が表示されることを確認

### 2. 変更履歴の記録確認

#### テストシナリオ1: 案件の作成

1. **案件管理ページ**（`http://localhost:3000/cases`）に移動
2. 「新規作成」ボタンをクリック
3. 新しい案件を登録（任意のデータを入力）
4. 「保存」ボタンをクリック
5. **変更履歴ページ**（`http://localhost:3000/change-history`）に移動
6. 最新の変更履歴を確認：
   - ✅ 変更タイプ: 「作成」（CREATE）
   - ✅ 案件番号: 作成した案件番号が表示される
   - ✅ 変更者: 現在のユーザー名が表示される
   - ✅ 変更日時: 現在の日時が表示される
7. アコーディオンを展開して、変更内容を確認：
   - ✅ 全フィールドの「変更後」値が表示される
   - ✅ 「変更前」は空（新規作成のため）

#### テストシナリオ2: 案件の更新

1. **案件管理ページ**に移動
2. 既存の案件を編集（「編集」ボタンをクリック）
3. 以下のフィールドを変更：
   - 数量: 100 → 150
   - ステータス: 見積中 → 受注済
4. 「保存」ボタンをクリック
5. **変更履歴ページ**に移動
6. 最新の変更履歴を確認：
   - ✅ 変更タイプ: 「更新」（UPDATE）
   - ✅ 変更フィールド: 最初に変更されたフィールド名が表示される
   - ✅ 変更前・変更後の値が表示される
7. アコーディオンを展開して、変更内容を確認：
   - ✅ 変更されたフィールドのみが「変更内容」テーブルに表示される
   - ✅ 変更前・変更後の値が正しく表示される

#### テストシナリオ3: 案件の削除

1. **案件管理ページ**に移動
2. 既存の案件を削除（「削除」ボタンをクリック）
3. 削除を確認
4. **変更履歴ページ**に移動
5. 最新の変更履歴を確認：
   - ✅ 変更タイプ: 「削除」（DELETE）
   - ✅ 削除された案件の情報が表示される
   - ✅ 全フィールドの「変更前」値が表示される
   - ✅ 「変更後」は空（削除のため）

### 3. 変更履歴のフィルタリング確認

1. **変更履歴ページ**に移動
2. フィルター機能をテスト：
   - **案件IDフィルタ**: 特定の案件IDを入力してフィルタリング
   - **変更タイプフィルタ**: 「作成」「更新」「削除」でフィルタリング
   - **ソート**: 変更日時、ID、案件IDでソート
3. フィルタリング結果が正しく表示されることを確認

### 4. 変更履歴の差分表示確認

1. 複数のフィールドが変更された案件の変更履歴を確認
2. アコーディオンを展開
3. 「変更内容」テーブルで以下を確認：
   - ✅ 変更された各フィールドが行ごとに表示される
   - ✅ 変更前の値が赤色背景で表示される
   - ✅ 変更後の値が緑色背景で表示される
   - ✅ フィールド名が日本語ラベルで表示される

---

## バックアップ機能の確認

### 1. 実行前のデータ確認

バックアップディレクトリが存在することを確認：

```bash
cd backend
dir backups
```

存在しない場合は、ディレクトリは自動的に作成されます。

### 2. バックアップ作成の確認

#### テストシナリオ1: 手動バックアップ作成

1. **バックアップ管理ページ**（`http://localhost:3000/backups`）に移動
2. 「バックアップ作成」ボタンをクリック
3. ダイアログでバックアップ名を入力（または空欄で自動生成）
4. 「作成」ボタンをクリック
5. バックアップ一覧を確認：
   - ✅ 新しいバックアップが一覧に表示される
   - ✅ ステータス: 「実行中」（in_progress）→「成功」（success）に変わる
   - ✅ バックアップ名、ファイルサイズ、レコード数が表示される
   - ✅ 作成日時が表示される

#### テストシナリオ2: バックアップファイルの確認

1. バックエンドディレクトリの`backups`フォルダを確認：
   ```bash
   cd backend
   dir backups
   ```
2. バックアップファイル（`.db`拡張子）が作成されていることを確認
3. ファイルサイズがデータベースファイルと同等であることを確認

### 3. バックアップ一覧の確認

1. **バックアップ管理ページ**に移動
2. バックアップ一覧が正しく表示されることを確認：
   - ✅ 全バックアップが表示される
   - ✅ ページネーションが機能する
   - ✅ フィルタリング（バックアップタイプ、ステータス）が機能する
   - ✅ ソート機能が機能する

### 4. バックアップ復元の確認

#### 実行前の準備

**⚠️ 重要: 復元は本番データを上書きするため、テスト環境でのみ実行してください。**

1. 現在のデータベースの状態を確認（案件数などをメモ）
2. テスト用のバックアップを作成（復元用）

#### 復元の実行

1. **バックアップ管理ページ**に移動
2. 復元したいバックアップの「復元」アイコンをクリック
3. 確認ダイアログで内容を確認：
   - ✅ バックアップ名が表示される
   - ✅ 警告メッセージが表示される
4. 「復元」ボタンをクリック
5. 復元が完了するのを待つ（ローディング表示）
6. 成功メッセージが表示されることを確認

#### 復元後のデータ確認

1. ブラウザをリフレッシュ
2. **案件管理ページ**に移動
3. 復元されたデータが正しく表示されることを確認：
   - ✅ 案件数が復元前の状態に戻っている
   - ✅ 案件データが正しく復元されている
4. **変更履歴ページ**に移動
5. 変更履歴も復元されていることを確認

### 5. バックアップ削除の確認

1. **バックアップ管理ページ**に移動
2. 削除したいバックアップの「削除」アイコンをクリック
3. 確認ダイアログで内容を確認
4. 「削除」ボタンをクリック
5. バックアップ一覧から削除されることを確認
6. `backups`フォルダからファイルが削除されていることを確認：
   ```bash
   cd backend
   dir backups
   ```

### 6. 自動バックアップ確認

#### スケジュールバックアップの手動実行

**注意**: このAPIは認証が必要です。ブラウザで直接URLを開いても「Not authenticated」エラーになります。以下のいずれかの方法を使用してください。

**方法1: FastAPI Swagger UI を使用（推奨）**

1. スーパーユーザーでログイン（デフォルト: `admin` / `admin`）
2. ブラウザで以下にアクセス:
   ```
   http://localhost:8000/docs
   ```
3. 右上の「Authorize」ボタンをクリック
4. ログイン情報を入力:
   - Username: `admin`
   - Password: `admin`
5. 「Authorize」をクリックして認証
6. 「POST /api/backups/run-scheduled」を探してクリック
7. 「Try it out」ボタンをクリック
8. 「Execute」ボタンをクリック
9. レスポンスを確認:
   ```json
   {
     "message": "スケジュールバックアップが作成されました: backup_20241128_123456",
     "executed": true,
     "backup_name": "backup_20241128_123456"
   }
   ```
10. バックアップ管理ページで確認：
    - ✅ バックアップタイプ: 「スケジュール」（scheduled）
    - ✅ ステータス: 「成功」（success）

**方法2: ブラウザの開発者ツールから実行**

1. スーパーユーザーでログイン（デフォルト: `admin` / `admin`）
2. ブラウザの開発者ツール（F12）を開く
3. 「Console」タブを開く
4. 以下のJavaScriptコードを実行:
   ```javascript
   // 認証トークンを取得（localStorageから）
   const token = localStorage.getItem('token');

   // APIを呼び出し
   fetch('http://localhost:8000/api/backups/run-scheduled', {
     method: 'POST',
     headers: {
       'Authorization': `Bearer ${token}`,
       'Content-Type': 'application/json'
     }
   })
   .then(response => response.json())
   .then(data => {
     console.log('実行結果:', data);
     if (data.executed) {
       alert('スケジュールバックアップが作成されました: ' + data.backup_name);
     } else {
       alert('メッセージ: ' + data.message);
     }
   })
   .catch(error => {
     console.error('エラー:', error);
     alert('エラーが発生しました');
   });
   ```
5. バックアップ管理ページで確認

**方法3: curlコマンドで実行（コマンドラインから）**

1. まずログインしてトークンを取得:
   ```bash
   curl -X POST http://localhost:8000/api/auth/login \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "username=admin&password=admin"
   ```
   レスポンスから `access_token` をコピー

2. スケジュールバックアップを実行:
   ```bash
   curl -X POST http://localhost:8000/api/backups/run-scheduled \
     -H "Authorization: Bearer <上記で取得したトークン>"
   ```

3. バックアップ管理ページで確認

**確認項目**:
- ✅ バックアップタイプ: 「スケジュール」（scheduled）
- ✅ ステータス: 「成功」（success）
- ✅ 作成日時が現在時刻になっている

#### 古いバックアップのクリーンアップ

1. **バックアップ管理ページ**に移動
2. 「古いバックアップを削除」ボタンをクリック
3. 確認ダイアログで「OK」をクリック
4. 30日以上前のバックアップが削除されることを確認：
   - ✅ 削除された件数が表示される
   - ✅ バックアップ一覧から削除される

---

## 確認チェックリスト

### 変更履歴機能

- [x] 案件作成時に変更履歴が記録される
- [x] 案件更新時に変更履歴が記録される（変更されたフィールドのみ）
- [x] 案件削除時に変更履歴が記録される
- [x] 変更履歴一覧が正しく表示される
- [x] 変更タイプ（作成/更新/削除）が正しく表示される
- [x] 変更者名が正しく表示される
- [x] 変更日時が正しく表示される（JST表示）
- [x] フィルタリング機能が動作する
- [x] ソート機能が動作する（案件番号ソート対応）
- [x] ページネーションが動作する
- [x] 差分表示（変更前・変更後）が正しく表示される
- [x] 複数フィールド変更時に全変更が表示される
- [x] _case_number_snapshotフィールドが非表示になっている

### バックアップ機能

- [x] 手動バックアップが作成できる
- [x] バックアップファイルがディスクに保存される
- [x] バックアップ一覧が正しく表示される
- [x] バックアップのステータス（成功/失敗/実行中）が正しく表示される
- [x] ファイルサイズとレコード数が正しく表示される
- [x] バックアップから復元ができる
- [x] 復元後のデータが正しい
- [x] 復元後にステータスが正しく更新される
- [x] バックアップの削除ができる
- [x] 削除後、ファイルも削除される
- [x] スケジュールバックアップが作成できる
- [x] 古いバックアップのクリーンアップが動作する
- [x] フィルタリング機能が動作する
- [x] ソート機能が動作する
- [x] ページネーションが動作する
- [x] 作成日時が日本標準時で表示される

---

## トラブルシューティング

### 変更履歴が記録されない

**症状**: 案件を作成・更新・削除しても変更履歴が記録されない

**確認事項**:
1. バックエンドサーバーのログを確認（エラーがないか）
2. データベースの`change_history`テーブルにレコードが追加されているか確認：
   ```sql
   SELECT * FROM change_history ORDER BY changed_at DESC LIMIT 10;
   ```
3. ブラウザのコンソールでエラーがないか確認

**解決方法**:
- バックエンドサーバーを再起動
- データベース接続を確認
- ログイン状態を確認

### 変更履歴の差分が表示されない

**症状**: 変更履歴は記録されているが、差分表示が正しくない

**確認事項**:
1. `changes_json`フィールドにデータが保存されているか確認：
   ```sql
   SELECT changes_json FROM change_history WHERE id = <履歴ID>;
   ```
2. ブラウザのコンソールでエラーがないか確認

**解決方法**:
- ページをリフレッシュ
- アコーディオンを開き直す
- ブラウザのキャッシュをクリア

### バックアップが作成できない

**症状**: 「バックアップ作成」ボタンをクリックしてもエラーが発生

**確認事項**:
1. `backups`ディレクトリに書き込み権限があるか確認
2. データベースファイルが存在するか確認：
   ```bash
   cd backend
   dir trade_dx.db
   ```
3. バックエンドサーバーのログを確認

**解決方法**:
- `backups`ディレクトリの権限を確認・修正
- バックエンドサーバーを再起動
- ディスク容量を確認

### バックアップの復元が失敗する

**症状**: 復元を実行してもエラーが発生

**確認事項**:
1. バックアップファイルが存在するか確認：
   ```bash
   cd backend
   dir backups\<バックアップファイル名>.db
   ```
2. データベースファイルに書き込み権限があるか確認
3. バックエンドサーバーのログを確認

**解決方法**:
- スーパーユーザーでログインしているか確認
- データベースファイルの権限を確認・修正
- バックエンドサーバーを再起動

### バックアップ一覧が表示されない

**症状**: バックアップ管理ページにアクセスしても一覧が表示されない

**確認事項**:
1. バックエンドAPIが正常に動作しているか確認：
   ```
   http://localhost:8000/api/backups
   ```
   ※ このエンドポイントも認証が必要です。直接アクセスすると「Not authenticated」エラーになります。
2. ブラウザのコンソールでエラーがないか確認
3. 認証トークンが有効か確認

**解決方法**:
- ログインし直す
- ブラウザのキャッシュをクリア
- バックエンドサーバーを再起動

### スケジュールバックアップの実行で「Not authenticated」エラーが出る

**症状**: ブラウザで `http://localhost:8000/api/backups/run-scheduled` にアクセスすると「Not authenticated」と表示される

**説明**:
- これは正常な動作です。このAPIは認証が必要なため、ブラウザで直接URLを開いても認証されていません。

**解決方法**:
- 上記の「方法1: FastAPI Swagger UI を使用」を参照してください。
- または、ブラウザの開発者ツール（方法2）またはcurlコマンド（方法3）を使用してください。

---

## まとめ

Phase 7の変更履歴・バックアップ機能が正常に動作していることを確認しました。

**確認完了日**: 2025-11-28

**確認完了後**:
- ✅ 変更履歴が自動的に記録される
- ✅ 変更内容の差分が視覚的に表示される
- ✅ バックアップが作成・管理できる
- ✅ バックアップから復元ができる
- ✅ 案件削除後も変更履歴が残る
- ✅ 変更履歴の案件番号が正しく表示される
- ✅ 日本標準時で日時が表示される

**ロック状態**:
- 🔒 Phase 7は完全ロック中
- 📝 エラー・修正記録: `backend/PHASE7_ERRORS_AND_FIXES.md`
- 🔐 実装ロック詳細: `backend/PHASE7_IMPLEMENTATION_LOCK.md`

次のフェーズ（Phase 8）に進む準備が整いました。

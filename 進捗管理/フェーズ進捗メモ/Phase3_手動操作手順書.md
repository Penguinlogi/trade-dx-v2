# Phase 3: 案件管理API - 手動操作手順書

## 📋 概要
このドキュメントは、Phase 3で実装した案件管理機能の動作確認手順をまとめたものです。

**実装内容:**
- 案件CRUD API (作成・参照・更新・削除)
- 案件一覧画面（フィルター・検索・ページネーション）
- 案件作成・編集モーダル
- 案件番号自動生成機能

---

## 1. テストデータの作成方法

### 1.1 シードデータの投入（推奨）

シードデータには、ユーザー、顧客マスタ、商品マスタ、案件番号管理の初期データが含まれています。

#### 方法1: バッチファイルから実行（Windows）- 推奨

```batch
cd backend
scripts\run_seed_simple.bat
```

または

```batch
cd backend
scripts\run_seed.bat
```

#### 方法2: Pythonスクリプトから直接実行

```batch
cd backend
py -3 -m scripts.seed_data
```

または

```batch
cd backend
python scripts\seed_data.py
```

#### 方法3: 仮想環境から実行

```batch
cd backend
venv\Scripts\activate
python scripts\seed_data.py
deactivate
```

### 1.2 シードデータの内容

**ユーザー:**
- `admin` / `admin123` (管理者)
- `yamada` / `yamada123` (山田太郎)
- `suzuki` / `suzuki123` (鈴木花子)

**顧客マスタ:**
- C001: ABC商事株式会社
- C002: XYZ物産株式会社
- C003: グローバル貿易株式会社

**商品マスタ:**
- P001: 電子部品A
- P002: プラスチック原料B
- P003: 金属パーツC
- P004: 繊維製品D

**案件番号管理:**
- 2025-EX: 輸出案件の連番管理（初期値: 0）
- 2025-IM: 輸入案件の連番管理（初期値: 0）

---

## 2. 実行前のデータ確認

### 2.1 データベースの確認

#### 方法1: SQLiteブラウザで確認

1. DB Browser for SQLite などのツールで `backend/trade_dx.db` を開く
2. 以下のテーブルを確認：
   - `users` - ユーザーが3件存在すること
   - `customers` - 顧客が3件存在すること
   - `products` - 商品が4件存在すること
   - `case_numbers` - 案件番号管理が2件（輸出・輸入）存在すること
   - `cases` - 案件が0件（または既存データ）であること

#### 方法2: スクリプトで確認

```batch
cd backend
python scripts\check_database.py
```

または

```batch
cd backend
scripts\check_db.bat
```

**期待される出力:**
```
=== データベース確認スクリプト ===

[ユーザー] 3件
  - admin (管理者)
  - yamada (山田太郎)
  - suzuki (鈴木花子)

[顧客マスタ] 3件
  - C001: ABC商事株式会社
  - C002: XYZ物産株式会社
  - C003: グローバル貿易株式会社

[商品マスタ] 4件
  - P001: 電子部品A
  - P002: プラスチック原料B
  - P003: 金属パーツC
  - P004: 繊維製品D

[案件番号管理] 2件
  - 2025-EX: 連番 0
  - 2025-IM: 連番 0

[案件] 0件

データベース確認完了
```

---

## 3. アプリケーションの起動方法

### ⚠️ 重要な起動順序

**必ず以下の順序で起動してください：**

1. **バックエンドを起動** ← 先に起動！
2. **フロントエンドを起動** ← 後に起動！

バックエンドが起動していない状態でフロントエンドにアクセスすると、真っ白なページが表示されます。

---

### 3.1 バックエンドの起動（先に起動）

#### 方法1: 仮想環境を使用

```batch
cd backend
venv\Scripts\activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

#### 方法2: 直接実行

```batch
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**確認ポイント:**
- サーバーが `http://localhost:8000` で起動すること
- ブラウザで `http://localhost:8000/docs` にアクセスしてAPI仕様が表示されること

### 3.2 フロントエンドの起動

**重要:** フロントエンドを起動する前に、必ずバックエンドを起動してください！

```batch
cd frontend
npm run dev
```

**確認ポイント:**
- 開発サーバーが `http://localhost:3000` で起動すること
- コンソールに以下のようなメッセージが表示されること：
  ```
  VITE v5.x.x  ready in xxx ms

  ➜  Local:   http://localhost:3000/
  ➜  Network: use --host to expose
  ```
- ブラウザで `http://localhost:3000` にアクセスすること

---

## 4. 手動操作による動作確認手順

### 4.1 ログイン

1. ブラウザで `http://localhost:3000` を開く
2. ログイン画面が表示されること
   - **もし真っ白なページが表示される場合**は、「7.11 フロントエンドが真っ白」のトラブルシューティングを参照
3. 以下のいずれかのユーザーでログイン：
   - ユーザー名: `admin`、パスワード: `admin123`
   - ユーザー名: `yamada`、パスワード: `yamada123`
4. ログインに成功すると、ダッシュボードまたは案件管理画面にリダイレクトされること

### 4.2 案件一覧画面の確認

1. サイドバーまたはメニューから「案件管理」をクリック
2. 案件一覧画面が表示されること
3. **確認項目:**
   - ページヘッダーに「案件管理」と表示されること
   - 「新規案件作成」ボタンが表示されること
   - 検索フォームが表示されること
   - フィルターボタンが表示されること
   - 案件がまだない場合、「案件が見つかりません」と表示されること

### 4.3 案件番号の自動生成機能の確認

#### ステップ1: 案件番号生成の準備

1. 「新規案件作成」ボタンをクリック
2. 案件作成モーダルが開くこと
3. 「区分」フィールドで「輸出」を選択
4. 「案件番号」フィールドの右側に ⚡ アイコンボタンが表示されること

#### ステップ2: 案件番号の自動生成

1. ⚡ アイコンボタンをクリック
2. 案件番号が自動生成されること
3. **期待される結果:** `2025-EX-001` のような形式の案件番号が生成される

#### ステップ3: 区分変更時の動作確認

1. 「区分」を「輸入」に変更
2. 再度 ⚡ アイコンボタンをクリック
3. **期待される結果:** `2025-IM-001` のような形式の案件番号が生成される

### 4.4 案件の新規作成

#### ステップ1: 基本情報の入力

1. 「新規案件作成」ボタンをクリック
2. 以下の情報を入力：

**テストケース1: 輸出案件**
```
案件番号: 2025-EX-001（自動生成または手動入力）
区分: 輸出
顧客ID: 1
仕入先名: サプライヤーA
商品ID: 1
数量: 1000
単位: pcs
販売単価: 200
仕入単価: 150
船積予定日: （今日から1ヶ月後の日付）
ステータス: 見積中
担当者: 山田太郎
備考: Phase 3 テストデータ - 輸出案件
```

3. 「作成」ボタンをクリック
4. モーダルが閉じること
5. 案件一覧に新しい案件が表示されること

#### ステップ2: 追加案件の作成

**テストケース2: 輸入案件**
```
案件番号: 2025-IM-001（自動生成）
区分: 輸入
顧客ID: 2
仕入先名: サプライヤーB
商品ID: 2
数量: 500
単位: kg
販売単価: 300
仕入単価: 250
船積予定日: （今日から2週間後の日付）
ステータス: 受注済
担当者: 鈴木花子
備考: Phase 3 テストデータ - 輸入案件
```

**テストケース3: 別の輸出案件**
```
案件番号: 2025-EX-002（自動生成）
区分: 輸出
顧客ID: 3
仕入先名: サプライヤーC
商品ID: 3
数量: 200
単位: pcs
販売単価: 600
仕入単価: 500
船積予定日: （今日から10日後の日付）
ステータス: 船積済
担当者: 山田太郎
備考: Phase 3 テストデータ - 輸出案件2
```

### 4.5 案件一覧の表示確認

1. 案件一覧画面を確認
2. **確認項目:**
   - 作成した案件がすべて表示されること
   - 案件番号が正しく表示されること
   - 区分が色分けされたチップで表示されること（輸出=青、輸入=紫）
   - 顧客名、商品名が表示されること
   - 売上額、粗利額、粗利率が計算されて表示されること
   - ステータスが色分けされたチップで表示されること
   - 担当者名が表示されること
   - 操作ボタン（詳細・編集・削除）が表示されること

### 4.6 検索機能の確認

#### ステップ1: キーワード検索

1. 検索ボックスに「2025-EX-001」と入力
2. 該当する案件のみが表示されること
3. 検索ボックスをクリアすると、すべての案件が再表示されること

#### ステップ2: 顧客名検索

1. 検索ボックスに「ABC商事」と入力
2. ABC商事に関連する案件のみが表示されること

#### ステップ3: 商品名検索

1. 検索ボックスに「電子部品」と入力
2. 電子部品に関連する案件のみが表示されること

### 4.7 フィルター機能の確認

1. 「フィルターを表示」ボタンをクリック
2. フィルターフォームが展開されること

#### ステップ1: 区分フィルター

1. 区分フィルターで「輸出」を選択
2. 輸出案件のみが表示されること
3. 区分フィルターで「輸入」を選択
4. 輸入案件のみが表示されること

#### ステップ2: ステータスフィルター

1. ステータスフィルターで「見積中」を選択
2. 見積中の案件のみが表示されること

#### ステップ3: 担当者フィルター

1. 担当者フィルターに「山田」と入力
2. 山田太郎が担当する案件のみが表示されること

#### ステップ4: フィルタークリア

1. 「クリア」ボタンをクリック
2. すべてのフィルターがクリアされ、全案件が表示されること

### 4.8 ソート機能の確認

1. ソートフィールドで「案件番号」を選択
2. 案件が案件番号順に並ぶこと
3. ソート順を「昇順」と「降順」で切り替え、正しく動作すること
4. ソートフィールドで「売上額」を選択
5. 案件が売上額順に並ぶこと

### 4.9 案件の編集

#### ステップ1: 編集モーダルを開く

1. 案件一覧から任意の案件の「編集」ボタン（鉛筆アイコン）をクリック
2. 案件編集モーダルが開くこと
3. 既存の案件データがフォームに表示されること

#### ステップ2: データを編集

1. 以下のフィールドを変更：
   - ステータス: 「受注済」→「船積済」
   - 数量: 元の値 + 100
   - 備考: 「（編集済み）」を追加
2. 「更新」ボタンをクリック
3. モーダルが閉じること
4. 案件一覧で変更が反映されていること

#### ステップ3: 計算値の確認

1. 数量を変更した案件の売上額、粗利額、粗利率が再計算されていること
2. 計算結果が正しいこと

### 4.10 案件の削除

1. 案件一覧から削除したい案件の「削除」ボタン（ゴミ箱アイコン）をクリック
2. 確認ダイアログが表示されること
3. 「OK」をクリック
4. 案件が一覧から削除されること
5. 削除後の案件数が正しく表示されること

### 4.11 ページネーション機能の確認

> **注:** この機能を確認するには、案件が20件以上必要です。

1. 案件を20件以上作成（または既存の案件を利用）
2. ページネーションが表示されること
3. 「2」ページ目に移動できること
4. ページ番号が正しく表示されること
5. 表示件数の範囲が正しく表示されること（例: "50件中 21〜40件を表示"）

---

## 5. 実行後のデータ確認

### 5.1 データベースの確認

#### 方法1: スクリプトで確認

```batch
cd backend
python scripts\check_database.py
```

**期待される出力:**
```
================================================================================
貿易DX データベース確認
================================================================================

テーブル一覧: users, customers, products, case_numbers, cases, ...

================================================================================
ユーザーテーブル (users)
================================================================================
ID    ユーザー名        メールアドレス                  フルネーム       アクティブ   管理者
--------------------------------------------------------------------------------
1     admin           admin@example.com             管理者           ○          ○
2     yamada          yamada@example.com            山田太郎         ○          ×
3     suzuki          suzuki@example.com            鈴木花子         ○          ×

合計: 3 件

================================================================================
顧客マスタ (customers)
================================================================================
ID    顧客コード     顧客名                          担当者
--------------------------------------------------------------------------------
1     C001         ABC商事株式会社                田中一郎
2     C002         XYZ物産株式会社                佐藤花子
3     C003         グローバル貿易株式会社          高橋次郎

合計: 3 件

================================================================================
商品マスタ (products)
================================================================================
ID    商品コード     商品名                          単位      標準価格
--------------------------------------------------------------------------------
1     P001         電子部品A                       pcs       150.00
2     P002         プラスチック原料B               kg        250.00
3     P003         金属パーツC                     pcs       500.00
4     P004         繊維製品D                       m         80.00

合計: 4 件

================================================================================
案件番号管理 (case_numbers)
================================================================================
ID    年度      貿易種別      コード    最終連番
--------------------------------------------------------------------------------
1     2025    輸出          EX      2
2     2025    輸入          IM      1

合計: 2 件

================================================================================
案件 (cases)
================================================================================
ID    案件番号        区分      顧客ID   商品ID   数量        ステータス     担当者
--------------------------------------------------------------------------------
1     2025-EX-001   輸出      1       1       1000.000  見積中        山田太郎
2     2025-IM-001   輸入      2       2       500.000   受注済        鈴木花子
3     2025-EX-002   輸出      3       3       200.000   船積済        山田太郎

合計: 3 件（削除した場合は件数が減ります）

================================================================================
✓ データベース確認完了
================================================================================
```

#### 方法2: SQLiteブラウザで確認

1. DB Browser for SQLite で `backend/trade_dx.db` を開く
2. `cases` テーブルを確認：
   - 作成した案件がすべて保存されていること
   - 案件番号、区分、顧客ID、商品IDなどが正しく保存されていること
   - 売上額、粗利額、粗利率が計算されて保存されていること
   - `created_by`、`updated_by` にログインユーザーのIDが保存されていること
   - `created_at`、`updated_at` にタイムスタンプが保存されていること

3. `case_numbers` テーブルを確認：
   - 輸出案件の連番が増えていること（例: `last_sequence = 2`）
   - 輸入案件の連番が増えていること（例: `last_sequence = 1`）

### 5.2 API動作確認（オプション）

#### Swagger UIでの確認

1. ブラウザで `http://localhost:8000/docs` を開く
2. 以下のエンドポイントを確認：

**案件一覧取得:**
- `GET /api/cases`
- 「Try it out」をクリック
- 「Execute」をクリック
- レスポンスに案件一覧が返されること

**案件詳細取得:**
- `GET /api/cases/{case_id}`
- `case_id` に `1` を入力
- 「Execute」をクリック
- 案件詳細が返されること

**案件番号生成:**
- `POST /api/case-numbers/generate`
- リクエストボディに `{"trade_type": "輸出"}` を入力
- 「Execute」をクリック
- 新しい案件番号が生成されること

---

## 6. 確認チェックリスト

### 6.1 バックエンド機能

- [ ] **環境構築**
  - [ ] バックエンドサーバーが正常に起動する
  - [ ] APIドキュメント（Swagger UI）にアクセスできる
  - [ ] データベースが作成されている

- [ ] **シードデータ**
  - [ ] ユーザーが3件作成されている
  - [ ] 顧客マスタが3件作成されている
  - [ ] 商品マスタが4件作成されている
  - [ ] 案件番号管理が2件（輸出・輸入）作成されている

- [ ] **案件CRUD API**
  - [ ] 案件一覧取得（GET /api/cases）が正常に動作する
  - [ ] 案件詳細取得（GET /api/cases/{id}）が正常に動作する
  - [ ] 案件作成（POST /api/cases）が正常に動作する
  - [ ] 案件更新（PUT /api/cases/{id}）が正常に動作する
  - [ ] 案件削除（DELETE /api/cases/{id}）が正常に動作する

- [ ] **フィルター・検索機能**
  - [ ] キーワード検索が正常に動作する
  - [ ] 区分フィルターが正常に動作する
  - [ ] ステータスフィルターが正常に動作する
  - [ ] 担当者フィルターが正常に動作する

- [ ] **ページネーション**
  - [ ] ページネーションが正常に動作する
  - [ ] ページサイズが正しく適用される
  - [ ] 総件数、総ページ数が正しく計算される

- [ ] **案件番号自動生成**
  - [ ] 案件番号生成（POST /api/case-numbers/generate）が正常に動作する
  - [ ] 輸出案件の案件番号が正しい形式で生成される（YYYY-EX-NNN）
  - [ ] 輸入案件の案件番号が正しい形式で生成される（YYYY-IM-NNN）
  - [ ] 連番が正しくインクリメントされる

- [ ] **計算機能**
  - [ ] 売上額が正しく計算される（数量 × 販売単価）
  - [ ] 粗利額が正しく計算される（売上額 - 仕入額）
  - [ ] 粗利率が正しく計算される（粗利額 / 売上額 × 100）

- [ ] **バリデーション**
  - [ ] 必須フィールドの検証が動作する
  - [ ] 数値フィールドの検証が動作する
  - [ ] 区分・ステータスの選択肢検証が動作する
  - [ ] 顧客ID・商品IDの存在確認が動作する

### 6.2 フロントエンド機能

- [ ] **環境構築**
  - [ ] フロントエンドサーバーが正常に起動する
  - [ ] ログイン画面が表示される

- [ ] **認証**
  - [ ] ログインが正常に動作する
  - [ ] ログイン後、適切な画面にリダイレクトされる

- [ ] **案件一覧画面**
  - [ ] 案件一覧が表示される
  - [ ] テーブルに案件データが正しく表示される
  - [ ] 区分が色分けされたチップで表示される
  - [ ] ステータスが色分けされたチップで表示される
  - [ ] 金額がフォーマットされて表示される（¥形式）
  - [ ] パーセンテージがフォーマットされて表示される
  - [ ] 日付がフォーマットされて表示される

- [ ] **検索機能**
  - [ ] 検索ボックスが表示される
  - [ ] キーワード検索が正常に動作する
  - [ ] 検索結果が正しく表示される
  - [ ] 検索をクリアすると全件表示に戻る

- [ ] **フィルター機能**
  - [ ] フィルターボタンが表示される
  - [ ] フィルターフォームが展開・非表示できる
  - [ ] 区分フィルターが正常に動作する
  - [ ] ステータスフィルターが正常に動作する
  - [ ] 担当者フィルターが正常に動作する
  - [ ] 日付範囲フィルターが正常に動作する
  - [ ] ソート機能が正常に動作する
  - [ ] クリアボタンでフィルターがリセットされる

- [ ] **ページネーション**
  - [ ] ページネーションコンポーネントが表示される
  - [ ] ページ番号をクリックして移動できる
  - [ ] 表示件数の範囲が正しく表示される

- [ ] **案件作成モーダル**
  - [ ] 「新規案件作成」ボタンから案件作成モーダルが開く
  - [ ] すべてのフォームフィールドが表示される
  - [ ] 案件番号自動生成ボタンが動作する
  - [ ] 区分に応じた案件番号が生成される
  - [ ] フォームのバリデーションが動作する
  - [ ] 「作成」ボタンで案件が作成される
  - [ ] 作成後、モーダルが閉じる
  - [ ] 作成後、一覧が更新される

- [ ] **案件編集モーダル**
  - [ ] 「編集」ボタンから案件編集モーダルが開く
  - [ ] 既存データがフォームに表示される
  - [ ] データを編集できる
  - [ ] 「更新」ボタンで案件が更新される
  - [ ] 更新後、モーダルが閉じる
  - [ ] 更新後、一覧が更新される

- [ ] **案件削除**
  - [ ] 「削除」ボタンで確認ダイアログが表示される
  - [ ] OKで案件が削除される
  - [ ] キャンセルで削除がキャンセルされる
  - [ ] 削除後、一覧が更新される

- [ ] **エラーハンドリング**
  - [ ] API エラー時にエラーメッセージが表示される
  - [ ] フォームエラー時にフィールドごとにエラーが表示される

### 6.3 データ整合性

- [ ] **案件データ**
  - [ ] 作成した案件がデータベースに保存されている
  - [ ] 案件番号が一意である
  - [ ] 顧客ID、商品IDが正しく保存されている
  - [ ] 計算フィールド（売上額、粗利額、粗利率）が正しく保存されている
  - [ ] 作成者ID、更新者IDが保存されている
  - [ ] タイムスタンプが保存されている

- [ ] **案件番号管理**
  - [ ] 案件番号の連番が正しくインクリメントされる
  - [ ] 年・区分ごとに独立して管理されている
  - [ ] 同じ案件番号が重複して生成されない

- [ ] **リレーション**
  - [ ] 案件から顧客情報が参照できる
  - [ ] 案件から商品情報が参照できる
  - [ ] 案件一覧で顧客名・商品名が表示される

---

## 7. トラブルシューティング

### 7.1 バックエンドが起動しない

**症状:** `uvicorn` 実行時にエラーが発生する

**原因と対処法:**

1. **仮想環境が有効化されていない**
   ```batch
   cd backend
   venv\Scripts\activate
   ```

2. **依存パッケージがインストールされていない**
   ```batch
   pip install -r requirements.txt
   ```

3. **ポート8000が既に使用されている**
   - 別のポートを使用する:
     ```batch
     uvicorn app.main:app --reload --port 8001
     ```
   - または、既存のプロセスを終了する

4. **データベースファイルが破損している**
   - データベースファイルを削除して再作成:
     ```batch
     del trade_dx.db
     python scripts\seed_data.py
     ```

### 7.2 フロントエンドが起動しない

**症状:** `npm run dev` 実行時にエラーが発生する

**原因と対処法:**

1. **node_modulesがインストールされていない**
   ```batch
   cd frontend
   npm install
   ```

2. **ポート3000が既に使用されている**
   - `vite.config.ts` でポートを変更する

3. **Node.jsのバージョンが古い**
   - Node.js 18以上をインストール

### 7.3 APIにアクセスできない（CORS エラー）

**症状:** ブラウザのコンソールに CORS エラーが表示される

**原因と対処法:**

1. **バックエンドのCORS設定を確認**
   - `backend/app/core/config.py` の `CORS_ORIGINS` にフロントエンドのURLが含まれているか確認
   - デフォルト: `["http://localhost:3000", "http://127.0.0.1:3000"]`

2. **ブラウザキャッシュをクリア**
   - ブラウザのキャッシュをクリアして再読み込み

### 7.4 ログインできない

**症状:** ユーザー名とパスワードを入力してもログインできない

**原因と対処法:**

1. **シードデータが投入されていない**
   ```batch
   cd backend
   python scripts\seed_data.py
   ```

2. **ユーザー名またはパスワードが間違っている**
   - シードデータの内容を確認:
     - `admin` / `admin123`
     - `yamada` / `yamada123`
     - `suzuki` / `suzuki123`

3. **バックエンドが起動していない**
   - バックエンドサーバーが正常に起動しているか確認

### 7.5 案件が作成できない

**症状:** 案件作成フォームで「作成」ボタンを押してもエラーになる

**原因と対処法:**

1. **必須フィールドが入力されていない**
   - すべての必須フィールド（*マーク付き）を入力

2. **顧客IDまたは商品IDが存在しない**
   - 存在する顧客ID（1, 2, 3）と商品ID（1, 2, 3, 4）を使用
   - シードデータが投入されているか確認

3. **数値フィールドに不正な値が入力されている**
   - 数量は1以上
   - 販売単価、仕入単価は0以上

4. **案件番号が重複している**
   - 案件番号を空にして自動生成させる
   - または、一意の案件番号を手動入力

### 7.6 案件番号が自動生成されない

**症状:** ⚡ ボタンをクリックしても案件番号が生成されない

**原因と対処法:**

1. **区分が選択されていない**
   - まず「区分」フィールドで「輸出」または「輸入」を選択

2. **バックエンドAPIにアクセスできない**
   - バックエンドサーバーが起動しているか確認
   - ブラウザのコンソールでエラーメッセージを確認

3. **案件番号管理テーブルが初期化されていない**
   ```batch
   cd backend
   python scripts\seed_data.py
   ```

### 7.7 フィルター・検索が動作しない

**症状:** フィルターや検索を実行しても結果が変わらない

**原因と対処法:**

1. **検索条件に一致する案件がない**
   - 検索キーワードやフィルター条件を変更して再試行

2. **JavaScriptエラーが発生している**
   - ブラウザのコンソールでエラーメッセージを確認
   - ページを再読み込み

3. **バックエンドのクエリパラメータが正しく処理されていない**
   - ブラウザの開発者ツールのネットワークタブでリクエストを確認
   - クエリパラメータが正しく送信されているか確認

### 7.8 計算値（売上額、粗利額、粗利率）が表示されない

**症状:** 案件一覧で計算フィールドが `-` または空欄で表示される

**原因と対処法:**

1. **数量、販売単価、仕入単価が未入力**
   - 案件を編集して、すべての価格フィールドに値を入力

2. **バックエンドで計算が実行されていない**
   - `backend/app/models/case.py` の `calculate_amounts()` メソッドが正しく動作しているか確認
   - 案件を更新すると自動的に再計算される

### 7.9 案件一覧が空のまま

**症状:** 案件を作成したのに一覧に表示されない

**原因と対処法:**

1. **ページが更新されていない**
   - ブラウザをリフレッシュ（F5）

2. **フィルターが適用されている**
   - 「クリア」ボタンをクリックしてフィルターをリセット

3. **案件が別のページに表示されている**
   - ページネーションで1ページ目に戻る

4. **データベースに保存されていない**
   - データベース確認スクリプトで案件が存在するか確認
   ```batch
   cd backend
   python scripts\check_database.py
   ```

### 7.10 削除した案件が復活する

**症状:** 案件を削除したのに、再度表示される

**原因と対処法:**

1. **削除が完了していない**
   - 削除確認ダイアログで「OK」をクリックしたか確認
   - ブラウザのコンソールでエラーメッセージを確認

2. **データベースのトランザクションが失敗している**
   - バックエンドのログを確認
   - データベース確認スクリプトで案件が本当に削除されているか確認

3. **キャッシュの問題**
   - ブラウザのキャッシュをクリア
   - ページを再読み込み

### 7.11 フロントエンドが真っ白（重要）

**症状:** `http://localhost:3000` にアクセスしても真っ白なページが表示される

**原因と対処法:**

1. **バックエンドが起動していない（最も多い原因）**
   - バックエンドを先に起動してください
   ```batch
   cd backend
   py -3 -m uvicorn app.main:app --reload
   ```
   - `http://localhost:8000` にアクセスして、バックエンドが動作しているか確認

2. **ブラウザのコンソールにエラーが表示されている**
   - F12キーを押して開発者ツールを開く
   - Consoleタブでエラーメッセージを確認
   - **よくあるエラー:**
     - `net::ERR_CONNECTION_REFUSED` → バックエンドが起動していない
     - `CORS error` → バックエンドのCORS設定を確認
     - JavaScriptエラー → フロントエンドのコードにエラーがある

3. **フロントエンドのビルドエラー**
   - ターミナルでエラーメッセージを確認
   - node_modulesを再インストール:
   ```batch
   cd frontend
   rmdir /s /q node_modules
   npm install
   npm run dev
   ```

4. **ポートの問題**
   - `http://localhost:3000` が正しいアドレスか確認
   - ターミナルに表示されているポート番号を確認

5. **ルーティングの問題**
   - `http://localhost:3000/login` に直接アクセスしてみる
   - ログイン画面が表示されればルーティングは正常

**詳細な診断手順:**

```batch
# 1. バックエンドの起動確認
curl http://localhost:8000/health
# または、ブラウザで http://localhost:8000/health にアクセス
# 正常な場合: {"status":"healthy","app_name":"貿易DX管理システム","version":"2.1.0"}

# 2. フロントエンドの再起動
cd frontend
npm run dev

# 3. ブラウザで確認
# http://localhost:3000/login にアクセス
# ログイン画面が表示されるはず
```

**それでも解決しない場合:**
- フロントエンドのターミナルとブラウザのコンソール（F12）のエラーメッセージをすべて確認
- バックエンドのログも確認

---

## 8. 次のステップ

Phase 3の動作確認が完了したら、以下を実施してください：

1. **進捗管理書の更新**
   - `進捗管理/全体進捗管理書.md` を開く
   - Phase 3のステータスを「✅ 完了」に更新
   - 完了日を記入

2. **Phase 4への準備**
   - Phase 4のタスク内容を確認
   - 必要なテストデータがあるか確認

3. **Git コミット（オプション）**
   - Phase 3の実装をコミット
   ```batch
   git add .
   git commit -m "feat: Phase 3 - 案件管理API実装完了"
   ```

---

## 9. 参考情報

### 9.1 関連ファイル

**バックエンド:**
- `backend/app/api/endpoints/cases.py` - 案件API
- `backend/app/api/endpoints/case_numbers.py` - 案件番号生成API
- `backend/app/models/case.py` - 案件モデル
- `backend/app/schemas/case.py` - 案件スキーマ

**フロントエンド:**
- `frontend/src/pages/CasesPage.tsx` - 案件一覧画面
- `frontend/src/components/Table/CaseTable.tsx` - 案件テーブルコンポーネント
- `frontend/src/components/Modal/CaseFormModal.tsx` - 案件フォームモーダル
- `frontend/src/api/cases.ts` - 案件API クライアント
- `frontend/src/api/caseNumbers.ts` - 案件番号API クライアント
- `frontend/src/types/case.ts` - 案件型定義

**データベース:**
- `backend/trade_dx.db` - SQLite データベースファイル
- `backend/scripts/seed_data.py` - シードデータ投入スクリプト
- `backend/scripts/check_database.py` - データベース確認スクリプト

### 9.2 API エンドポイント一覧

**案件管理:**
- `GET /api/cases` - 案件一覧取得
- `GET /api/cases/{id}` - 案件詳細取得
- `POST /api/cases` - 案件作成
- `PUT /api/cases/{id}` - 案件更新
- `DELETE /api/cases/{id}` - 案件削除
- `GET /api/cases/stats/summary` - 案件統計情報取得

**案件番号管理:**
- `POST /api/case-numbers/generate` - 案件番号生成
- `GET /api/case-numbers/current/{trade_type}` - 現在の連番取得

**認証:**
- `POST /api/auth/login` - ログイン
- `POST /api/auth/logout` - ログアウト
- `GET /api/auth/me` - 現在のユーザー情報取得
- `POST /api/auth/refresh` - トークンリフレッシュ

### 9.3 データベーススキーマ

**casesテーブル:**
```sql
CREATE TABLE cases (
    id INTEGER PRIMARY KEY,
    case_number VARCHAR(20) UNIQUE NOT NULL,
    trade_type VARCHAR(10) NOT NULL,
    customer_id INTEGER NOT NULL,
    supplier_name VARCHAR(100),
    product_id INTEGER NOT NULL,
    quantity NUMERIC(15, 3) NOT NULL,
    unit VARCHAR(10) NOT NULL,
    sales_unit_price NUMERIC(15, 2) NOT NULL,
    purchase_unit_price NUMERIC(15, 2) NOT NULL,
    sales_amount NUMERIC(15, 2),
    gross_profit NUMERIC(15, 2),
    gross_profit_rate NUMERIC(5, 2),
    shipment_date DATE,
    status VARCHAR(20) NOT NULL,
    pic VARCHAR(50) NOT NULL,
    notes TEXT,
    created_by INTEGER,
    updated_by INTEGER,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (product_id) REFERENCES products(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    FOREIGN KEY (updated_by) REFERENCES users(id)
);
```

**case_numbersテーブル:**
```sql
CREATE TABLE case_numbers (
    id INTEGER PRIMARY KEY,
    year INTEGER NOT NULL,
    trade_type VARCHAR(10) NOT NULL,
    trade_type_code VARCHAR(2) NOT NULL,
    last_sequence INTEGER NOT NULL,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    UNIQUE (year, trade_type)
);
```

---

## 10. 動作確認完了の報告

Phase 3の動作確認がすべて完了したら、以下の情報を記録してください：

**確認者:** _______________
**確認日:** _______________
**確認結果:** □ 合格 □ 不合格

**コメント:**
```
（動作確認時に気づいた点、問題点、改善提案などを記入）



```

**未解決の問題:**
```
（解決できなかった問題があれば記入）



```

---

**Phase 3 手動操作手順書 - 終わり**

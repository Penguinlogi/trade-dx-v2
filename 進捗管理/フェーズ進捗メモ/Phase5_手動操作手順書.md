# Phase 5: ダッシュボード・集計機能 - 手動操作手順書

**作成日**: 2025-11-27
**対象バージョン**: V2.1 Web
**対象フェーズ**: Phase 5

---

## 📋 目次

1. [概要](#概要)
2. [事前準備](#事前準備)
3. [テストデータの確認](#テストデータの確認)
4. [動作確認手順](#動作確認手順)
5. [確認チェックリスト](#確認チェックリスト)
6. [トラブルシューティング](#トラブルシューティング)

---

## 概要

このフェーズでは、以下の機能を実装しました：

### バックエンド機能
- ✅ 集計サマリーAPI (`GET /api/analytics/summary`)
  - 総案件数、進行中案件数、完了案件数
  - 顧客数、商品数
  - 今月・先月の案件数と売上額
  - 案件ステータス分布

- ✅ 月次トレンドAPI (`GET /api/analytics/trends`)
  - 指定期間の月次案件数と売上額のトレンド

- ✅ 顧客別売上TOP API (`GET /api/analytics/by-customer`)
  - 顧客別の案件数と総売上額のランキング

### フロントエンド機能
- ✅ サマリーカード（8種類）
  - 総案件数、進行中案件、完了案件
  - 顧客数、商品数、今月の案件数
  - 今月の売上額（前月比表示）、先月の売上額

- ✅ 案件ステータス分布（円グラフ）
  - 見積中、受注済、船積済、完了、キャンセル別の件数と割合

- ✅ 月次トレンドグラフ（折れ線グラフ + 棒グラフ）
  - 案件数推移（折れ線グラフ）
  - 売上額推移（棒グラフ）
  - 期間選択（6ヶ月、12ヶ月、24ヶ月）

- ✅ 顧客別売上TOP10（テーブル）
  - 順位、顧客コード、顧客名、案件数、総売上額
  - 表示件数選択（TOP 5、TOP 10、TOP 20）

---

## 事前準備

### 1. システムの起動確認

#### バックエンドの起動

**方法1: uvicornを使用（推奨）**
```cmd
cd backend
.\venv\Scripts\activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**方法2: Pythonモジュールとして実行**
```cmd
cd backend
.\venv\Scripts\activate
python -m app.main
```

**確認ポイント**:
- `http://localhost:8000` でサーバーが起動していること
- コンソールに `Application startup complete` が表示されること

#### フロントエンドの起動
```cmd
cd frontend
npm run dev
```

**確認ポイント**:
- `http://localhost:3000` でアプリケーションが起動していること
- ブラウザで開けること

### 2. ログイン

1. ブラウザで `http://localhost:3000` を開く
2. ログイン画面でテストユーザーでログイン
   - **ユーザー名**: `admin`
   - **パスワード**: `admin123`

---

## テストデータの確認

### 実行前のデータ確認

#### 方法1: SQLiteコマンドでデータ確認

```cmd
cd backend
sqlite3 trade_dx.db
```

```sql
-- 案件数の確認
SELECT COUNT(*) as total_cases FROM cases;

-- ステータス別件数の確認
SELECT status, COUNT(*) as count
FROM cases
GROUP BY status
ORDER BY count DESC;

-- 顧客別売上TOP10の確認
SELECT
    c.customer_code,
    c.customer_name,
    COUNT(ca.id) as case_count,
    SUM(ca.sales_amount) as total_revenue
FROM customers c
JOIN cases ca ON c.id = ca.customer_id
GROUP BY c.id, c.customer_code, c.customer_name
ORDER BY total_revenue DESC
LIMIT 10;

-- 月次集計の確認
SELECT
    strftime('%Y-%m', created_at) as year_month,
    COUNT(*) as case_count,
    SUM(sales_amount) as revenue
FROM cases
WHERE created_at >= date('now', '-12 months')
GROUP BY strftime('%Y-%m', created_at)
ORDER BY year_month;

-- SQLiteを終了
.exit
```

#### 方法2: curlコマンドでAPI確認

まず、トークンを取得：
```cmd
curl -X POST "http://localhost:8000/api/auth/login" ^
  -H "Content-Type: application/json" ^
  -d "{\"username\":\"admin\",\"password\":\"admin123\"}"
```

取得したトークンを使用してAPI確認：
```cmd
set TOKEN=取得したアクセストークン

REM サマリーデータの取得
curl -X GET "http://localhost:8000/api/analytics/summary" ^
  -H "Authorization: Bearer %TOKEN%"

REM 月次トレンドの取得（12ヶ月）
curl -X GET "http://localhost:8000/api/analytics/trends?period_months=12" ^
  -H "Authorization: Bearer %TOKEN%"

REM 顧客別売上TOP10の取得
curl -X GET "http://localhost:8000/api/analytics/by-customer?limit=10" ^
  -H "Authorization: Bearer %TOKEN%"
```

---

## 動作確認手順

### Step 1: ダッシュボード画面の表示確認

1. ログイン後、ダッシュボード画面が表示されることを確認
2. 画面上部に以下が表示されていることを確認：
   - ✅ ヘッダー（アプリ名、ユーザー名、更新ボタン、ログアウトボタン）
   - ✅ 「ダッシュボード」タイトル

### Step 2: サマリーカードの確認

**サマリーカードが8枚表示されること**：

| カード名 | 表示内容 | 確認ポイント |
|---------|---------|-------------|
| 総案件数 | 数値 + 青いアイコン | 全案件の合計数 |
| 進行中案件 | 数値 + オレンジアイコン | 見積中+受注済+船積済の合計 |
| 完了案件 | 数値 + 緑アイコン | 完了ステータスの件数 |
| 顧客数 | 数値 + 水色アイコン | 顧客マスタの総数 |
| 商品数 | 数値 + 紫アイコン | 商品マスタの総数 |
| 今月の案件数 | 数値 + 青いアイコン | 当月作成の案件数 |
| 今月の売上額 | 金額 + 前月比 | 緑の背景、前月比矢印 |
| 先月の売上額 | 金額 | 水色の背景 |

**確認項目**：
- [ ] 全8枚のカードが表示される
- [ ] 各カードに数値が表示される（0でもOK）
- [ ] 今月の売上額に前月比の増減が表示される
- [ ] 増加時は緑の上向き矢印、減少時は赤の下向き矢印

### Step 3: クイックアクセスカードの確認

**3枚のカードが表示されること**：
- [ ] 「案件管理」カード → クリックで `/cases` に遷移
- [ ] 「顧客マスタ」カード → クリックで `/customers` に遷移
- [ ] 「商品マスタ」カード → クリックで `/products` に遷移

### Step 4: 案件ステータス分布の確認

**円グラフの表示確認**：
- [ ] 「案件ステータス分布」というタイトルが表示される
- [ ] 円グラフが表示される
- [ ] 各セクションに割合（%）が表示される
- [ ] 凡例が表示される（見積中、受注済、船積済、完了、キャンセル）
- [ ] グラフの下に詳細リストが表示される
  - ステータス名
  - 色付きの丸印
  - 件数と割合

**操作確認**：
- [ ] グラフの各セクションにマウスオーバーすると詳細が表示される
- [ ] 凡例のアイテムをクリックするとそのセクションが表示/非表示される

### Step 5: 顧客別売上TOP10の確認

**テーブルの表示確認**：
- [ ] 「顧客別売上TOP10」というタイトルが表示される
- [ ] 右上に「表示件数」の選択ボックスが表示される
- [ ] テーブルに以下の列が表示される：
  - 順位（1-3位はトロフィーアイコン、4位以降は番号チップ）
  - 顧客コード
  - 顧客名
  - 案件数
  - 総売上額

**ランク表示の確認**：
- [ ] 1位: 赤いトロフィー
- [ ] 2位: オレンジのトロフィー
- [ ] 3位: 青いトロフィー
- [ ] 4位以降: グレーのチップ

**テーブル下部の確認**：
- [ ] 合計行が表示される
  - 総案件数
  - 総売上額

**操作確認 - 表示件数の変更**：
1. 「表示件数」で「TOP 5」を選択
   - [ ] テーブルが5件だけ表示される
2. 「表示件数」で「TOP 20」を選択
   - [ ] テーブルが最大20件表示される（データがある場合）

### Step 6: 月次トレンドグラフの確認

**グラフの表示確認**：
- [ ] 「月次トレンド（12ヶ月）」というタイトルが表示される
- [ ] 右上に「期間」の選択ボックスが表示される
- [ ] 2つのグラフが表示される：
  1. 案件数推移（折れ線グラフ、青色）
  2. 売上額推移（棒グラフ、紫色）

**グラフの詳細確認**：
- [ ] X軸に年月（YYYY-MM形式）が表示される
- [ ] Y軸に数値が表示される
- [ ] 折れ線グラフに点が表示される
- [ ] 凡例が表示される

**操作確認 - マウスオーバー**：
- [ ] グラフにマウスオーバーすると詳細が表示される
  - 年月
  - 案件数（折れ線グラフ）
  - 売上額（棒グラフ）

**操作確認 - 期間の変更**：
1. 「期間」で「6ヶ月」を選択
   - [ ] タイトルが「月次トレンド（6ヶ月）」に変わる
   - [ ] グラフが再描画される
   - [ ] 6ヶ月分のデータが表示される

2. 「期間」で「24ヶ月」を選択
   - [ ] タイトルが「月次トレンド（24ヶ月）」に変わる
   - [ ] グラフが再描画される
   - [ ] 24ヶ月分のデータが表示される（データがある場合）

### Step 7: データ更新機能の確認

1. ヘッダーの「更新」ボタン（回転矢印アイコン）をクリック
   - [ ] ローディング表示が出る
   - [ ] 全てのデータが再取得される
   - [ ] グラフとテーブルが更新される

### Step 8: エラーハンドリングの確認

**バックエンドを停止してエラーを確認**：
1. バックエンドサーバーを停止（Ctrl+C）
2. フロントエンドで「更新」ボタンをクリック
   - [ ] エラーメッセージが赤い帯で表示される
   - [ ] 「データの取得に失敗しました」というメッセージが表示される
3. バックエンドサーバーを再起動
4. 「更新」ボタンをクリック
   - [ ] データが正常に取得される
   - [ ] エラーメッセージが消える

---

## 確認チェックリスト

### ✅ 基本機能

- [ ] ダッシュボード画面が正常に表示される
- [ ] サマリーカード（8枚）が表示される
- [ ] クイックアクセスカード（3枚）が表示される
- [ ] 案件ステータス分布（円グラフ）が表示される
- [ ] 顧客別売上TOP10（テーブル）が表示される
- [ ] 月次トレンドグラフが表示される

### ✅ サマリーカード

- [ ] 総案件数が表示される
- [ ] 進行中案件数が表示される
- [ ] 完了案件数が表示される
- [ ] 顧客数が表示される
- [ ] 商品数が表示される
- [ ] 今月の案件数が表示される
- [ ] 今月の売上額が表示される
- [ ] 先月の売上額が表示される
- [ ] 前月比の増減が表示される（矢印と%）

### ✅ 案件ステータス分布

- [ ] 円グラフが表示される
- [ ] 各ステータスの割合が表示される
- [ ] 凡例が表示される
- [ ] 詳細リストが表示される
- [ ] マウスオーバーで詳細が表示される

### ✅ 顧客別売上TOP

- [ ] テーブルが表示される
- [ ] 順位アイコン（トロフィー）が正しく表示される
- [ ] 顧客コードと顧客名が表示される
- [ ] 案件数と総売上額が表示される
- [ ] 合計行が表示される
- [ ] 表示件数を変更できる（5, 10, 20）

### ✅ 月次トレンド

- [ ] 案件数推移（折れ線グラフ）が表示される
- [ ] 売上額推移（棒グラフ）が表示される
- [ ] X軸とY軸が適切に表示される
- [ ] マウスオーバーで詳細が表示される
- [ ] 期間を変更できる（6, 12, 24ヶ月）

### ✅ 操作機能

- [ ] データ更新ボタンが動作する
- [ ] ローディング表示が出る
- [ ] エラー時にメッセージが表示される
- [ ] クイックアクセスカードから各画面に遷移できる

### ✅ レスポンシブ対応

- [ ] ブラウザ幅を狭くしてもレイアウトが崩れない
- [ ] カードが適切に折り返される
- [ ] グラフが画面幅に合わせてリサイズされる

---

## 実行結果の期待値

### サマリーデータの例

```json
{
  "summary": {
    "total_cases": 50,
    "active_cases": 30,
    "completed_cases": 18,
    "total_customers": 15,
    "total_products": 25,
    "this_month_cases": 8,
    "this_month_revenue": 12500000,
    "last_month_revenue": 10000000
  },
  "status_distribution": [
    {"status": "見積中", "count": 10, "percentage": 20.0},
    {"status": "受注済", "count": 15, "percentage": 30.0},
    {"status": "船積済", "count": 5, "percentage": 10.0},
    {"status": "完了", "count": 18, "percentage": 36.0},
    {"status": "キャンセル", "count": 2, "percentage": 4.0}
  ]
}
```

### トレンドデータの例

```json
{
  "trends": [
    {"year_month": "2024-12", "case_count": 8, "revenue": 10000000},
    {"year_month": "2025-01", "case_count": 10, "revenue": 12000000},
    {"year_month": "2025-02", "case_count": 12, "revenue": 15000000}
  ],
  "period_months": 12
}
```

### 顧客別売上の例

```json
{
  "top_customers": [
    {
      "customer_id": 1,
      "customer_code": "C001",
      "customer_name": "株式会社ABC",
      "case_count": 15,
      "total_revenue": 50000000
    },
    {
      "customer_id": 2,
      "customer_code": "C002",
      "customer_name": "XYZ商事",
      "case_count": 12,
      "total_revenue": 40000000
    }
  ],
  "limit": 10
}
```

---

## トラブルシューティング

### 問題1: バックエンドの起動エラー「ImportError: attempted relative import」

**症状**:
```
ImportError: attempted relative import with no known parent package
```

**原因**:
- `python app\main.py` という実行方法では相対インポートが機能しない

**解決方法**:
以下のいずれかの方法で実行：

```cmd
REM 方法1: uvicornを使用（推奨）
cd backend
.\venv\Scripts\activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

REM 方法2: Pythonモジュールとして実行
cd backend
.\venv\Scripts\activate
python -m app.main
```

### 問題1-2: バックエンドの起動エラー「cannot import name 'get_current_user'」

**症状**:
```
ImportError: cannot import name 'get_current_user' from 'app.core.security'
```

**原因**:
- `get_current_user` は `app.core.security` ではなく `app.core.deps` にある
- このエラーは既に修正済みです

**解決方法**:
- 既に修正されているので、通常は発生しません
- もし発生した場合は、最新のコードを取得してください

### 問題2: データが表示されない

**症状**:
- ダッシュボードにデータが表示されない
- 「データがありません」と表示される

**原因**:
- データベースに案件データが存在しない
- API呼び出しが失敗している

**解決方法**:
1. 案件データが存在するか確認：
   ```cmd
   cd backend
   sqlite3 trade_dx.db
   SELECT COUNT(*) FROM cases;
   .exit
   ```

2. 案件が0件の場合、案件一覧画面から新規案件を作成

3. ダッシュボードで「更新」ボタンをクリック

### 問題3: グラフが表示されない

**症状**:
- 円グラフや折れ線グラフが表示されない
- 空白の領域だけ表示される

**原因**:
- rechartsライブラリが正しくインストールされていない
- データの形式が不正

**解決方法**:
1. rechartsを再インストール：
   ```cmd
   cd frontend
   npm install recharts
   ```

2. ブラウザのコンソールでエラーを確認（F12キー）

3. ページをリロード（Ctrl+R）

### 問題4: 前月比が正しく計算されない

**症状**:
- 前月比が0%と表示される
- 増減の矢印が表示されない

**原因**:
- 先月のデータが存在しない
- 先月の売上額が0円

**解決方法**:
1. これは正常な動作です（先月のデータがない場合）
2. 先月分の案件を作成するか、既存案件の作成日を変更

### 問題5: API呼び出しエラー

**症状**:
- 赤いエラーメッセージが表示される
- 「データの取得に失敗しました」

**原因**:
- バックエンドサーバーが起動していない
- 認証トークンが無効

**解決方法**:
1. バックエンドサーバーの状態を確認：
   ```cmd
   cd backend
   .\venv\Scripts\activate
   uvicorn app.main:app --reload
   ```

2. ブラウザで `http://localhost:8000/docs` にアクセスして API ドキュメントが表示されるか確認

3. 一度ログアウトして再ログイン

### 問題6: データ更新ボタンが動作しない

**症状**:
- 更新ボタンをクリックしても何も起きない
- ローディング表示が出ない

**原因**:
- JavaScriptエラーが発生している
- イベントハンドラーが正しく設定されていない

**解決方法**:
1. ブラウザのコンソールを開く（F12キー）
2. エラーメッセージを確認
3. ページをリロード（Ctrl+R）
4. 必要に応じてブラウザのキャッシュをクリア（Ctrl+Shift+Delete）

### 問題7: レイアウトが崩れる

**症状**:
- カードやグラフが重なって表示される
- テキストがはみ出す

**原因**:
- ブラウザの互換性問題
- CSSが正しく読み込まれていない

**解決方法**:
1. ブラウザを最新バージョンに更新
2. 推奨ブラウザを使用（Chrome, Edge, Firefox の最新版）
3. ブラウザのズーム設定を100%にする
4. ページをリロード（Ctrl+R）

### 問題8: 日本語が文字化けする

**症状**:
- グラフやテーブルの日本語が正しく表示されない

**原因**:
- 文字エンコーディングの問題
- フォントの問題

**解決方法**:
1. ブラウザの文字エンコーディング設定を確認（UTF-8に設定）
2. ページをリロード（Ctrl+R）
3. 別のブラウザで試す

---

## 実行後の確認

### データの整合性確認

1. **サマリーカードの数値が正しいか**
   - 総案件数 = 進行中案件 + 完了案件 + キャンセル案件
   - 今月の案件数 ≤ 総案件数

2. **ステータス分布の合計が100%になるか**
   - 各ステータスの割合を合計すると100%（誤差±0.1%は許容）

3. **顧客別売上の合計が整合しているか**
   - テーブル下部の合計値が各行の合計と一致

4. **月次トレンドの連続性**
   - グラフに欠損月がないか
   - 異常な増減がないか

---

## 次のステップ

Phase 5の動作確認が完了したら、次のフェーズに進みます：

- **Phase 6**: ドキュメント生成機能（Invoice、Packing List）
- **Phase 7**: 変更履歴・バックアップ機能
- **Phase 8**: リアルタイム同期・通知機能
- **Phase 9**: テストとデバッグ

---

## 補足情報

### 使用技術

**バックエンド**:
- SQLAlchemy の集計関数（`func.count`, `func.sum`, `func.coalesce`）
- 日付関数（`strftime`, `extract`）
- グルーピングとソート

**フロントエンド**:
- React Hooks（`useState`, `useEffect`）
- Material-UI コンポーネント
- recharts グラフライブラリ
  - PieChart（円グラフ）
  - LineChart（折れ線グラフ）
  - BarChart（棒グラフ）

### パフォーマンス考慮

- API呼び出しは `Promise.all` で並列実行
- グラフは `ResponsiveContainer` でレスポンシブ対応
- データ更新時はローディング表示を出してUXを向上

---

## まとめ

Phase 5では、ダッシュボード・集計機能を実装しました。この機能により、以下が実現されました：

✅ **一目で業務状況を把握**
- サマリーカードで重要な数値を表示
- 前月比で売上の増減を確認

✅ **視覚的なデータ分析**
- 円グラフでステータス分布を確認
- 折れ線グラフと棒グラフでトレンドを把握

✅ **顧客別の売上分析**
- TOP10ランキングで主要顧客を特定
- 案件数と売上額を同時に確認

この手順書に従って動作確認を行い、問題があればトラブルシューティングを参照してください。

---

**作成者**: AI Assistant
**更新日**: 2025-11-27
